{% extends 'home/tes.html' %}
{% load widget_tweaks %}
{% load static %}

{% block content %}
{% include "courses/course_set.html" %}

<section class="bg-white p-6 rounded-xl shadow-sm mt-6">

    <h2 class="text-xl font-semibold mb-4">
        {% if edit_mode %} update question {% else %} create question {% endif %}
    </h2>
    <a href="{% url 'courses:view-question' idcourse=course.id idsection=section.id idassessment=assessment.id %}"
    class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-800 mb-4">
        <i class="fas fa-arrow-left"></i> Back to list Questions
    </a>
    <form method="POST" id="questionForm">
        {% csrf_token %}

        <!-- ===================== FORM PERTANYAAN ===================== -->
        <div class="mb-6">
            <label class="font-semibold block mb-2">question</label>
            {{ question_form.text }}
        </div>

        <!-- ===================== FORMSET ===================== -->
        <h3 class="font-semibold text-lg mb-3">answer choices</h3>

        {{ choice_formset.management_form }}

        <div id="choices-wrapper" class="space-y-4">

            {% for form in choice_formset %}
            <div class="choice-item bg-white border border-gray-200 rounded-xl p-4 shadow-sm"
                 data-form-index="{{ forloop.counter0 }}">

                {{ form.id }}
                {{ form.is_correct }}
                {{ form.DELETE.as_hidden }}
            <style>
                input[name$="-DELETE"] {
                    display: none;
                }
            </style>

                <div class="flex items-start gap-4">

                    <!-- Checkbox benar -->
                    <input type="checkbox"
                           class="correct-checkbox h-5 w-5 mt-1 rounded border-gray-300 text-indigo-600"
                           {% if form.initial.is_correct %}checked{% endif %}>

                    <!-- Textarea -->
                    <div class="w-full">
                        {{ form.text }}
                    </div>

                    <!-- Checkbox hapus -->
                    <label class="delete-form flex items-center text-red-600 cursor-pointer font-medium mt-1">
                        <input type="checkbox" class="delete-checkbox h-5 w-5">
                        <i class="fas fa-trash-alt"></i>
                    </label>

                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ===================== EMPTY FORM TEMPLATE ===================== -->
        <template id="empty-form-template">
            <div class="choice-item bg-white border border-gray-200 rounded-xl p-4 shadow-sm"
                 data-form-index="__prefix__">

                {{ choice_formset.empty_form.id }}
                {{ choice_formset.empty_form.is_correct }}
                {{ choice_formset.empty_form.DELETE }}

                <div class="flex items-start gap-4">

                    <!-- Checkbox benar -->
                    <input type="checkbox"
                           class="correct-checkbox h-5 w-5 mt-1 rounded border-gray-300 text-indigo-600">

                    <!-- Textarea -->
                    <div class="w-full">
                        {{ choice_formset.empty_form.text }}
                    </div>

                    <!-- Checkbox hapus -->
                    <label class="delete-form flex items-center text-red-600 cursor-pointer font-medium mt-1">
                        <input type="checkbox" class="delete-checkbox h-5 w-5">
                        <i class="fas fa-trash-alt"></i>
                    </label>

                </div>
            </div>
        </template>

        <!-- Button tambah -->
        <div class="mt-4">
            <button type="button"
                    id="addChoiceBtn"
                    class="px-4 py-2 bg-green-600 text-white rounded-xl shadow-sm hover:shadow-md hover:bg-green-700 transition">
                + Add Choice
            </button>
        </div>

        
        {% block extra_head %}
        {{ question_form.media }}
{% endblock extra_head %} 

        <!-- Submit -->
        <div class="mt-6 flex gap-3">
            <button class="px-6 py-3 bg-indigo-600 text-white rounded-xl shadow-sm hover:bg-indigo-700 hover:shadow-md transition">
                Save
            </button>
            {% if not edit_mode %}
            <button name="save_and_add_another"
                    class="px-6 py-3 bg-gray-600 text-white rounded-xl shadow-sm hover:bg-gray-700 hover:shadow-md transition">
                Save & Add Another
            </button>
            {% endif %}
            

        </div>

    </form>
</section>

<!-- ============================================ JAVASCRIPT ============================================ -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    /* ============================================================
       SYNC CHECKBOX BENAR (correct)
    ============================================================ */
    function bindCorrectCheckbox() {
        const checkboxes = document.querySelectorAll(".correct-checkbox");

        checkboxes.forEach(chk => {
            chk.onclick = function () {
                const hidden = this.closest(".choice-item")
                                   .querySelector("input[name$='is_correct']");

                {% if assessment.multiple_answer %}
                    hidden.value = this.checked ? "True" : "False";
                    return;
                {% endif %}

                checkboxes.forEach(cb => {
                    cb.checked = false;
                    cb.closest(".choice-item")
                      .querySelector("input[name$='is_correct']").value = "False";
                });

                this.checked = true;
                hidden.value = "True";
            };
        });
    }

    /* ============================================================
       DELETE FORMSET: SET VALUE "on" (Django requirement)
    ============================================================ */
    function bindDeleteButtons() {
        const deleteChecks = document.querySelectorAll(".delete-checkbox");

        deleteChecks.forEach(box => {
            box.onchange = function () {
                const item = this.closest(".choice-item");
                const hiddenDelete = item.querySelector("input[name$='DELETE']");

                if (this.checked) {
                    hiddenDelete.value = "on";                     // WAJIB UNTUK DJANGO
                    item.classList.add("opacity-40");             // tampak tidak aktif
                    item.querySelector("textarea").disabled = true;
                    item.querySelector(".correct-checkbox").disabled = true;
                } else {
                    hiddenDelete.value = "";
                    item.classList.remove("opacity-40");
                    item.querySelector("textarea").disabled = false;
                    item.querySelector(".correct-checkbox").disabled = false;
                }
            };
        });
    }

    bindCorrectCheckbox();
    bindDeleteButtons();

    /* ============================================================
       ADD FORM DINAMIS
    ============================================================ */
    const wrapper = document.getElementById("choices-wrapper");
    const addBtn = document.getElementById("addChoiceBtn");
    const template = document.getElementById("empty-form-template").innerHTML;
    const totalForms = document.getElementById("id_choices-TOTAL_FORMS");

    addBtn.onclick = function () {
        let index = parseInt(totalForms.value);
        let newForm = template.replace(/__prefix__/g, index);

        wrapper.insertAdjacentHTML("beforeend", newForm);

        totalForms.value = index + 1;

        bindCorrectCheckbox();
        bindDeleteButtons();
    };

});
</script>

{% endblock %}
