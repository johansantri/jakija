{% extends 'home/tes.html' %}
{% load widget_tweaks %}
{% load static %}

{% block content %}
{% include "courses/course_set.html" %}

<div class="container mx-auto px-4 py-12 max-w-6xl">
    <div class="bg-white rounded-3xl shadow-2xl border border-gray-200 overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-10 py-8">
            <h1 class="text-3xl font-bold">Buat Soal Baru</h1>
            <p class="mt-2 text-lg opacity-90">Assessment: <strong>{{ assessment.title }}</strong></p>
        </div>

        <div class="p-10">
            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="mb-8 p-6 rounded-xl text-center font-medium {% if message.tags == 'success' %}bg-green-50 text-green-800 border border-green-300{% else %}bg-red-50 text-red-800 border border-red-300{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <form method="post" enctype="multipart/form-data" novalidate>
                {% csrf_token %}
                {{ question_form.media }} {# CKEditor JS/CSS #}

                <!-- ==================== PERTANYAAN ==================== -->
                <div class="bg-gray-50 rounded-2xl p-10 mb-10 border border-gray-200">
                    <h2 class="text-2xl font-bold mb-8 text-gray-800 flex items-center gap-3">
                        <span class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">1</span>
                        Pertanyaan
                    </h2>

                    <div class="space-y-8">
                        <div>
                            <label class="block text-lg font-medium text-gray-700 mb-4">
                                Teks Pertanyaan <span class="text-red-500">*</span>
                            </label>
                            {{ question_form.text }}
                        </div>

                       
                    </div>
                </div>

                <!-- ==================== PILIHAN JAWABAN ==================== -->
                <div class="bg-gray-50 rounded-2xl p-10 border border-gray-200">
                    <h2 class="text-2xl font-bold mb-8 text-gray-800 flex items-center gap-3">
                        <span class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">2</span>
                        Pilihan Jawaban
                    </h2>

                    {{ choice_formset.management_form }}

                    <div id="choice-container" class="space-y-8">
                        <!-- Hanya tampilkan 1 pilihan saat pertama kali load -->
                        {% for form in choice_formset %}
                            {% if forloop.counter0 == 0 %}
                                <div class="choice-item bg-white rounded-2xl border-2 border-gray-300 p-8 hover:border-indigo-500 transition relative group">
                                    <button type="button" onclick="removeChoice(this)" class="absolute top-4 right-4 text-red-600 hover:text-red-800 text-3xl font-bold opacity-0 group-hover:opacity-100 transition z-10">
                                        ×
                                    </button>

                                    <div class="flex items-start gap-8 pr-12">
                                        <div class="pt-3 flex-shrink-0">
                                            <label class="flex items-center gap-3 cursor-pointer font-medium select-none">
                                                {{ form.is_correct }}
                                                <span class="text-lg text-gray-700">Benar</span>
                                            </label>
                                        </div>

                                        <div class="flex-1">
                                            {{ form.id }}
                                            {{ form.text }}
                                            {{ form.DELETE }} {# Hidden input untuk Django #}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <button type="button" id="add-choice" class="mt-10 inline-flex items-center gap-3 px-10 py-5 bg-indigo-600 text-white font-bold text-lg rounded-xl hover:bg-indigo-700 transition shadow-lg">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/>
                        </svg>
                        Tambah Pilihan Jawaban
                    </button>
                </div>

                <!-- ==================== TOMBOL SUBMIT ==================== -->
                <div class="mt-12 pt-8 border-t-2 border-gray-200 flex flex-col sm:flex-row gap-6 justify-end">
                    <a href="{% url 'courses:view-question' course.id section.id assessment.id %}" 
                       class="px-12 py-5 border-2 border-gray-400 text-gray-700 rounded-xl hover:bg-gray-100 transition font-medium text-center text-lg">
                        Batal
                    </a>
                    <button type="submit" name="save_and_add_another" 
                            class="px-12 py-5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition font-bold text-lg shadow-lg">
                        Simpan & Tambah Lagi
                    </button>
                    <button type="submit" 
                            class="px-14 py-5 bg-green-600 text-white rounded-xl hover:bg-green-700 transition font-bold text-lg shadow-lg">
                        Simpan Soal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ==================== TEMPLATE UNTUK PILIHAN BARU (TERSSEMBUNYI) ==================== -->
<template id="choice-template">
    <div class="choice-item bg-white rounded-2xl border-2 border-gray-300 p-8 hover:border-indigo-500 transition relative group mt-8">
        <button type="button" onclick="removeChoice(this)" class="absolute top-4 right-4 text-red-600 hover:text-red-800 text-3xl font-bold opacity-0 group-hover:opacity-100 transition z-10">
            ×
        </button>

        <div class="flex items-start gap-8 pr-12">
            <div class="pt-3 flex-shrink-0">
                <label class="flex items-center gap-3 cursor-pointer font-medium select-none">
                    <input type="checkbox" name="__prefix__-is_correct" id="id___prefix__-is_correct" class="w-6 h-6 text-indigo-600 rounded focus:ring-indigo-500">
                    <span class="text-lg text-gray-700">Benar</span>
                </label>
            </div>

            <div class="flex-1">
                {{ choice_formset.empty_form.id }}
                {{ choice_formset.empty_form.text }}
                {{ choice_formset.empty_form.DELETE }}
            </div>
        </div>
    </div>
</template>

<!-- ==================== SCRIPT DINAMIS (TAMBAH & HAPUS) ==================== -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const container = document.getElementById('choice-container');
        const totalForms = document.querySelector('#id_{{ choice_formset.prefix }}-TOTAL_FORMS');
        const template = document.getElementById('choice-template');

        window.addChoice = function () {
            const count = parseInt(totalForms.value);

            if (count >= 10) {
                alert('Maksimal 10 pilihan jawaban!');
                return;
            }

            // Clone dari <template>
            const clone = template.content.cloneNode(true);
            const htmlString = clone.firstElementChild.outerHTML;

            // Ganti semua __prefix__ jadi angka urut
            const newHtml = htmlString.replace(/__prefix__/g, count);

            // Buat elemen baru
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newHtml;

            // Masukkan ke container
            container.appendChild(tempDiv.firstElementChild);

            // Tambah jumlah form
            totalForms.value = count + 1;
        };

        window.removeChoice = function (btn) {
            const item = btn.closest('.choice-item');
            const deleteInput = item.querySelector('input[name$="-DELETE"]');

            if (deleteInput) {
                // Pilihan lama → centang DELETE + visual ilang
                deleteInput.checked = true;
                item.style.opacity = '0.3';
                item.style.pointerEvents = 'none';
                btn.style.display = 'none';
            } else {
                // Pilihan baru → hapus langsung
                item.remove();
                totalForms.value = parseInt(totalForms.value) - 1;
            }
        };

        document.getElementById('add-choice').addEventListener('click', addChoice);
    });
</script>

<!-- ==================== STYLING CKEDITOR ==================== -->
<style>
    .ck-editor__editable { 
        min-height: 140px !important; 
    }
    .ck.ck-toolbar { 
        border-radius: 12px 12px 0 0 !important; 
        background: #f8fafc; 
    }
    .ck.ck-editor__main > .ck-editor__editable {
        border-radius: 0 0 12px 12px !important;
    }
    .choice-item { 
        position: relative; 
    }
    .choice-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
</style>

{% endblock %}