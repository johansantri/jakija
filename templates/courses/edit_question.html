{% extends "home/tes.html" %}
{% load static widget_tweaks %}

{% block content %}

<form method="post" class="space-y-10">
    {% csrf_token %}

    <!-- ================================
         QUESTION FORM
    ================================= -->
    <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-4">
            {% if edit_mode %} Edit Soal {% else %} Buat Soal {% endif %}
        </h2>

        {{ question_form.non_field_errors }}

        <div class="mb-6">
            {{ question_form.text.label_tag }}
            {{ question_form.text }}
            {{ question_form.text.errors }}
        </div>
    </div>


    <!-- ================================
         CHOICE FORMSET
    ================================= -->
    <div class="bg-white p-6 rounded-xl shadow space-y-6">

        <h3 class="text-lg font-semibold">Pilihan Jawaban</h3>

        <!-- MANAGEMENT FORM -->
        {{ choice_formset.management_form }}

        <div id="choices-container" class="space-y-6">

            {% for form in choice_formset %}

            <div class="choice-form-row border p-5 rounded-xl bg-gray-50 relative">

                {{ form.id }} 
                {{ form.DELETE }} <!-- HARUS ADA -->

                <div class="flex items-start gap-4">

                    <!-- Radio Kunci Jawaban -->
                    <div>
                        <input type="radio"
                               name="correct-answer"
                               class="correct-radio h-5 w-5 mt-2"
                               data-target="{{ form.prefix }}-is_correct"
                               {% if form.instance.is_correct %} checked {% endif %}>
                    </div>

                    <!-- Jawaban -->
                    <div class="flex-1">
                        {{ form.text }}
                        {{ form.text.errors }}
                    </div>

                </div>

                <!-- Hidden field is_correct -->
                {{ form.is_correct }}

                <!-- Tombol hapus -->
                <button type="button"
                        class="delete-choice text-red-600 absolute top-3 right-3">
                    Hapus
                </button>

            </div>

            {% endfor %}

        </div>

        <button id="add-choice"
                type="button"
                class="px-4 py-2 bg-indigo-600 text-white rounded-lg">
            + Tambah Pilihan
        </button>

    </div>


    <!-- ================================
         SUBMIT
    ================================= -->
    <div class="text-right">
        <button type="submit"
                class="px-6 py-3 bg-green-600 text-white rounded-xl">
            Simpan
        </button>
    </div>

</form>


<!-- ================================
     JAVASCRIPT
================================= -->
<script>
/* =====================================
   DELETE BUTTON (FIX UTAMA)
===================================== */
document.addEventListener("click", function (e) {
    if (e.target.classList.contains("delete-choice")) {

        let row = e.target.closest(".choice-form-row");
        let deleteField = row.querySelector('input[name$="-DELETE"]');

        deleteField.checked = true;      // wajib kirim DELETE ke Django
        row.style.display = "none";      // sembunyikan saja
    }
});


/* =====================================
   RADIO: SYNC KE is_correct hidden
===================================== */
document.addEventListener("change", function (e) {
    if (e.target.classList.contains("correct-radio")) {

        // matikan semua radio
        document.querySelectorAll(".correct-radio").forEach(r => r.checked = false);

        // nyalakan radio yang diklik
        e.target.checked = true;

        // set semua is_correct ke false dulu
        document.querySelectorAll('input[name$="-is_correct"]').forEach(hidden => {
            hidden.value = "";
        });

        // set yang dipilih ke true
        let targetField = document.getElementById(e.target.dataset.target);
        targetField.value = "True";
    }
});


/* =====================================
   ADD FORMSET ITEM
===================================== */
document.getElementById("add-choice").addEventListener("click", function () {
    let formCount = document.getElementById("id_choices-TOTAL_FORMS");
    let current = parseInt(formCount.value);

    let container = document.getElementById("choices-container");

    // clone form terakhir
    let newForm = container.children[0].cloneNode(true);

    // update prefix
    newForm.innerHTML = newForm.innerHTML.replace(/choices-\d+/g, `choices-${current}`);
    newForm.style.display = "";  

    // reset field
    newForm.querySelectorAll("textarea,input[type='text']").forEach(el => el.value = "");
    newForm.querySelectorAll("input[type='hidden'][name$='-is_correct']").forEach(el => el.value = "");
    newForm.querySelector(".correct-radio").checked = false;

    container.appendChild(newForm);

    formCount.value = current + 1;

    // re-init CKEditor jika pakai CKEditor
    if (typeof ClassicEditor !== "undefined") {
        newForm.querySelectorAll(".ck-editor__editable").forEach(el => el.remove());
    }
});
</script>

{% endblock %}
