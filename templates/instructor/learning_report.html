{% extends 'home/tes.html' %}
{% load static %}
{% block content %}

<div class="container mx-auto mt-5">
    <h2 class="text-2xl font-semibold mb-4">Instructor Learning Progress Report</h2>
    <p class="mb-4">Instructor: <strong>{{ instructor.user.username }}</strong></p>

    <!-- Filters -->
    <form method="get" class="mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Filter by Course</label>
                <select name="course_id" onchange="this.form.submit()"
                    class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">All Courses</option>
                    {% for course in courses %}
                        <option value="{{ course.id }}" {% if selected_course == course.id|stringformat:"s" %}selected{% endif %}>
                            {{ course.course_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Filter by Learner</label>
                <select name="learner_id" onchange="this.form.submit()"
                    class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">All Learners</option>
                    {% for learner in all_learners %}
                        <option value="{{ learner.id }}" {% if selected_learner == learner.id|stringformat:"s" %}selected{% endif %}>
                            {{ learner.username }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </form>

    <!-- Export -->
    <a href="?export=true{% if selected_course %}&course_id={{ selected_course }}{% endif %}{% if selected_learner %}&learner_id={{ selected_learner }}{% endif %}"
       class="inline-block mb-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
        Export to CSV
    </a>

    {% if report_data %}
    <div class="space-y-4">
        {% for data in report_data %}
        <div class="border rounded-lg shadow-sm">

            <!-- Accordion Header -->
            <button type="button"
                onclick="toggleAccordion('acc-{{ forloop.counter }}')"
                class="w-full px-4 py-3 flex justify-between items-center text-left bg-gray-100 hover:bg-gray-200 font-semibold">
                <span>{{ data.learner.username }} — {{ data.course.course_name }}</span>
                <span class="text-gray-500">▼</span>
            </button>

            <!-- Accordion Content -->
            <div id="acc-{{ forloop.counter }}" class="hidden px-4 py-4 bg-white space-y-2">

                <p><strong>Full Name:</strong>
                    <a href="{% url 'instructor:instructor_learner_detail_report' %}?learner_id={{ data.learner.id }}"
                       class="ml-2 inline-block bg-blue-500 text-white text-xs px-2 py-1 rounded">
                        {{ data.learner_full_name }}
                    </a>
                </p>

                <p><strong>Email:</strong> {{ data.learner_email }}</p>
                <p><strong>University:</strong> {{ data.learner_university }}</p>
                <p><strong>Gender:</strong> {{ data.learner_gender|title }}</p>

                <p><strong>Progress:</strong> {{ data.progress_percentage|floatformat:2 }}%</p>
                <p><strong>Materials Read:</strong>
                    {{ data.materials_read }}/{{ data.total_materials }}
                    ({{ data.materials_read_percentage|floatformat:2 }}%)
                </p>
                <p><strong>Assessments Completed:</strong>
                    {{ data.assessments_completed }}/{{ data.total_assessments }}
                    ({{ data.assessments_completed_percentage|floatformat:2 }}%)
                </p>

                <p>
                    <strong>Threshold:</strong> {{ data.threshold|floatformat:2 }}
                    <strong class="ml-4">Total Score:</strong> {{ data.total_score|floatformat:2 }}
                    <strong class="ml-4">Status:</strong>
                    <span class="{% if data.status == 'Pass' %}text-green-600{% else %}text-red-600{% endif %}">
                        {{ data.status }}
                    </span>
                </p>

                <p><strong>Last Login:</strong>
                    {% if data.last_login %}
                        {{ data.last_login|date:"Y-m-d H:i:s" }}
                    {% else %}
                        Never logged in
                    {% endif %}
                </p>

                <!-- Materials -->
                <h5 class="font-semibold mt-4">Material Access</h5>
                {% if data.material_access_details %}
                <div class="overflow-x-auto">
                    <table class="w-full border text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 border">Material</th>
                                <th class="p-2 border">Access Time</th>
                                <th class="p-2 border">Duration (min)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for m in data.material_access_details %}
                            <tr>
                                <td class="p-2 border">{{ m.material_name }}</td>
                                <td class="p-2 border">{{ m.access_time|date:"Y-m-d H:i:s" }}</td>
                                <td class="p-2 border">
                                    {% if m.duration %}{{ m.duration|floatformat:2 }}{% else %}N/A{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <p class="text-gray-500">No materials accessed.</p>
                {% endif %}

                <!-- Assessments -->
                <h5 class="font-semibold mt-4">Assessment Breakdown</h5>
                <div class="overflow-x-auto">
                    <table class="w-full border text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 border">Assessment</th>
                                <th class="p-2 border">Weight</th>
                                <th class="p-2 border">Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for a in data.assessment_details %}
                            <tr class="{% if a.name == 'Total' %}font-bold bg-gray-50{% endif %}">
                                <td class="p-2 border">{{ a.name }}</td>
                                <td class="p-2 border">{{ a.weight|floatformat:2 }}</td>
                                <td class="p-2 border">{{ a.score|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    <div class="mt-6 flex justify-center space-x-2">
        {% if page_obj.has_previous %}
        <a class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"
           href="?page={{ page_obj.previous_page_number }}{% if selected_course %}&course_id={{ selected_course }}{% endif %}{% if selected_learner %}&learner_id={{ selected_learner }}{% endif %}">
            Previous
        </a>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        <a class="px-3 py-1 rounded {% if page_obj.number == num %}bg-blue-500 text-white{% else %}bg-gray-200 hover:bg-gray-300{% endif %}"
           href="?page={{ num }}{% if selected_course %}&course_id={{ selected_course }}{% endif %}{% if selected_learner %}&learner_id={{ selected_learner }}{% endif %}">
            {{ num }}
        </a>
        {% endfor %}

        {% if page_obj.has_next %}
        <a class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"
           href="?page={{ page_obj.next_page_number }}{% if selected_course %}&course_id={{ selected_course }}{% endif %}{% if selected_learner %}&learner_id={{ selected_learner }}{% endif %}">
            Next
        </a>
        {% endif %}
    </div>

    {% else %}
        <p class="mt-6 text-center text-gray-500">No data available.</p>
    {% endif %}
</div>

<script>
function toggleAccordion(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle('hidden');
}
</script>

{% endblock %}
