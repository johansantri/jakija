{% extends 'home/tes.html' %}
{% load extra_custom_filters %}
{% block content %}

<div class="course-container">

    <h1 class="text-2xl font-bold">{{ course.course_name }}</h1>

    <!-- ================= MATERIAL ================= -->
    {% if current_content.0 == 'material' %}
        <div class="material-section mt-4 p-4 border rounded">
            <h2 class="text-xl font-semibold">{{ material.title }}</h2>
            <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 lg:p-12 prose prose-lg lg:prose-xl max-w-none text-gray-700">
                {{ material.description|make_iframes_responsive|safe }}
            </div>
        </div>
    {% endif %}

    <!-- ================= ASSESSMENT ================= -->
    {% if current_content.0 == 'assessment' %}
        <div class="assessment-section mt-4 p-4 border rounded">
            <h2 class="text-xl font-semibold">{{ assessment.title }}</h2>
                <!-- ===== MCQ ===== -->
               {% if assessment.questions.exists %}
                <div class="mcq-section mt-4">
                    <h3 class="font-semibold mb-2">Pilihan Ganda</h3>
                    
                    <form method="post">
                        {% csrf_token %}
                        {% for question in assessment.questions.all %}
                            <div class="question mb-4 p-3 border rounded">
                                <p class="font-medium"><strong>{{ question.text|safe }}</strong></p>

                                {% if question.choices.exists %}
                                    {% for choice in question.choices.all %}
                                        <div class="flex items-center mb-1">
                                            <input type="radio"
                                                  id="q{{ question.id }}_c{{ choice.id }}"
                                                  name="question_{{ question.id }}"
                                                  value="{{ choice.id }}"
                                                  class="mr-2">
                                            <label for="q{{ question.id }}_c{{ choice.id }}">{{ choice.text|safe }}</label>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-sm text-gray-500 italic">Belum ada pilihan.</p>
                                {% endif %}
                            </div>
                        {% endfor %}
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                            Submit Jawaban
                        </button>
                    </form>
                </div>
                {% endif %}


            <!-- ORA -->
            {% if assessment.ask_oras.all %}
                <div class="ora-section mt-2">
                    <h3 class="font-semibold">Open Response</h3>
                    {% for ao in assessment.ask_oras.all %}
                        <div class="ora-item mb-2">
                            <p class="font-medium">{{ ao.title }}</p>
                            <p>{{ ao.question_text|safe }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {% if assessment.quizzes.exists %}
              <div class="video-quiz-section mt-4">
                  <h3 class="font-semibold mb-2">{{ assessment.title }} (Video Quiz)</h3>

                  {% with video=assessment.quizzes.first.video %}
                  <div class="relative w-full overflow-hidden rounded-lg shadow-lg" style="padding-top: 56.25%;">
                      <video id="videoPlayer" class="absolute inset-0 w-full h-full rounded-lg" controls>
                          <source src="{{ video.file.url }}" type="video/mp4">
                          Your browser does not support the video tag.
                      </video>
                  </div>
                  {% endwith %}

                  <div id="quizContainer" class="mt-4"></div>
              </div>

              <script>
                  // Pastikan JSON valid
                  const quizzes = {{ video_quizzes_json|safe }};

                  const video = document.getElementById('videoPlayer');
                  const container = document.getElementById('quizContainer');
                  let currentQuizIndex = 0;

                  function showQuiz(quiz) {
                      container.innerHTML = '';
                      let html = `<div class="p-4 border rounded bg-gray-50 mb-2">
                                      <p class="font-medium mb-2">${quiz.question}</p>`;
                      quiz.options.forEach(opt => {
                          html += `<div class="flex items-center mb-1">
                                      <input type="radio" id="quiz${quiz.id}_opt${opt.id}" name="quiz_${quiz.id}" class="mr-2">
                                      <label for="quiz${quiz.id}_opt${opt.id}">${opt.text}</label>
                                  </div>`;
                      });
                      html += `</div>`;
                      container.innerHTML = html;
                  }

                  video.addEventListener('timeupdate', () => {
                      if (currentQuizIndex >= quizzes.length) return;

                      const quiz = quizzes[currentQuizIndex];
                      if (video.currentTime >= quiz.time_in_video) {
                          showQuiz(quiz);
                          currentQuizIndex++;
                      }
                  });
              </script>
              {% endif %}


            <!-- LTI -->
            {% if assessment.lti_tool %}
                <div class="lti-section mt-2">
                    <h3 class="font-semibold">LTI Tool</h3>
                    <p>Assessment menggunakan LTI tool.</p>
                </div>
            {% endif %}
        </div>
    {% endif %}

    <!-- ================= COMMENTS ================= -->
    <div class="comments-section mt-4 p-4 border rounded">
        <h3 class="font-semibold">Comments</h3>
        {% for comment in comments %}
            <div class="comment mb-2 border p-2 rounded">
                <p><strong>{{ comment.user.username }}</strong>: {{ comment.text }}</p>
                <small>{{ comment.created_at }}</small>
            </div>
        {% empty %}
            <p>No comments yet.</p>
        {% endfor %}
    </div>

    <!-- ================= NAVIGATION ================= -->
    <div class="navigation mt-4 flex justify-between">
        <a href="{{ previous_url }}" class="bg-gray-200 px-4 py-2 rounded">Previous</a>
        <a href="{{ next_url }}" class="bg-gray-200 px-4 py-2 rounded">Next</a>
    </div>

</div>

{% endblock %}
