{% extends 'home/tes.html' %}
{% load static %}

{% block content %}
<!-- Dashboard Grid -->
<section class="bg-white border border-gray-200 p-6 rounded-lg shadow-sm hover:shadow-md transition">
    {% include "courses/course_set.html" %}
 <br>
    <!-- Status dan Pesan -->
    <div class="mb-6 bg-white shadow-lg rounded-lg p-6">
        <h5 class="text-2xl font-semibold text-gray-800 mb-4">Current Status</h5>
        <p class="text-gray-700 mb-2">
            <strong>Status:</strong>
            {% if course.status_course == 'curation' %}
                <span class="bg-blue-600 text-white px-3 py-1 rounded-full">{{ course.status_course.get_status_display }}</span>
            {% elif course.status_course == 'draft' %}
                <span class="bg-yellow-500 text-white px-3 py-1 rounded-full">{{ course.status_course.get_status_display }}</span>
            {% elif course.status_course == 'published' %}
                <span class="bg-green-500 text-white px-3 py-1 rounded-full">{{ course.status_course.get_status_display }}</span>
            {% elif course.status_course == 'rejected' %}
                <span class="bg-red-600 text-white px-3 py-1 rounded-full">{{ course.status_course.get_status_display }}</span>
            {% else %}
                <span class="bg-gray-600 text-white px-3 py-1 rounded-full">{{ course.status_course.get_status_display }}</span>
            {% endif %}
        </p>
        <p class="text-gray-700"><strong>Latest Message:</strong> {{ course.status_course.manual_message|default:"No message" }}</p>
    </div>

    <!-- Informasi Author -->
    <div class="mb-6 bg-white shadow-lg rounded-lg p-6">
        <h5 class="text-2xl font-semibold text-gray-800 mb-4">Information Partner</h5>
        <ul class="space-y-3 text-gray-700">
            <li><strong>Full Name:</strong> {{ author_full_name }}</li>
            <li><strong>Email:</strong> {{ author_email }}</li>
            <li><strong>University:</strong> {{ author_university }}</li>
            <li><strong>Gender:</strong> {{ author_gender|title }}</li>
        </ul>
    </div>

    <!-- Detail Kursus -->
    <div class="mb-6 bg-white shadow-lg rounded-lg p-6">
        <h5 class="text-2xl font-semibold text-gray-800 mb-4">Course Details</h5>
        <ul class="space-y-3 text-gray-700">
            <li><strong>Partner:</strong> {{ course.org_partner.name }}</li>
            <li><strong>Instructor:</strong> {{ course.instructor.user.username|default:"Not assigned" }}</li>
            <li><strong>Category:</strong> {{ course.category.name }}</li>
            <li><strong>Level:</strong> {{ course.level|title }}</li>
            <li><strong>Language:</strong> {{ course.get_language_display }}</li>
            <li><strong>Start Date:</strong> {{ course.start_date|default:"N/A" }}</li>
            <li><strong>End Date:</strong> {{ course.end_date|default:"N/A" }}</li>
        </ul>
    </div>

    <!-- Riwayat Status -->
    <div class="mb-6 bg-white shadow-lg rounded-lg p-6">
        <h5 class="text-2xl font-semibold text-gray-800 mb-4">Status History</h5>
        {% if status_history %}
            <div class="overflow-x-auto">
                <table class="min-w-full table-auto text-sm text-gray-800">
                    <thead>
                        <tr class="bg-gray-100 text-left">
                            <th class="px-4 py-2">Status</th>
                            <th class="px-4 py-2">Action</th>
                            <th class="px-4 py-2">Message</th>
                            <th class="px-4 py-2">Changed By</th>
                            <th class="px-4 py-2">Changed At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in status_history %}
                            <tr class="{% if entry.status == 'draft' and entry.changed_by.is_partner %}bg-red-100{% elif entry.status == 'published' %}bg-green-100{% elif entry.status == 'curation' and entry.changed_by.is_superuser %}bg-red-100{% endif %}">
                                <td class="px-4 py-2">{{ entry.get_status_display }}</td>
                                <td class="px-4 py-2">
                                    {% if entry.status == 'curation' and entry.changed_by.is_instructor %}
                                        <span class="bg-blue-600 text-white px-3 py-1 rounded-full">Submitted by Instructor</span>
                                    {% elif entry.status == 'curation' and entry.changed_by.is_partner %}
                                        <span class="bg-teal-500 text-white px-3 py-1 rounded-full">Accepted by Partner</span>
                                    {% elif entry.status == 'draft' and entry.changed_by.is_partner %}
                                        <span class="bg-red-600 text-white px-3 py-1 rounded-full">Rejected by Partner</span>
                                    {% elif entry.status == 'published' and entry.changed_by.is_superuser %}
                                        <span class="bg-green-600 text-white px-3 py-1 rounded-full">Published by Admin</span>
                                    {% elif entry.status == 'curation' and entry.changed_by.is_superuser %}
                                        <span class="bg-red-600 text-white px-3 py-1 rounded-full">Rejected by Admin</span>
                                    {% else %}
                                        <span class="bg-gray-500 text-white px-3 py-1 rounded-full">Updated</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-2">{{ entry.manual_message|default:"No message" }}</td>
                                <td class="px-4 py-2">{{ entry.changed_by.username }}</td>
                                <td class="px-4 py-2">{{ entry.changed_at|date:"Y-m-d H:i:s" }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-gray-600">No status history available.</p>
        {% endif %}
    </div>

    <!-- Aksi Berdasarkan Peran -->
    <div class="mb-6 bg-white shadow-lg rounded-lg p-6">
        <h5 class="text-2xl font-semibold text-gray-800 mb-4">Actions</h5>
        <form method="post">
            {% csrf_token %}
            <div class="mb-4">
                <label for="message" class="block text-lg text-gray-800">Message:</label>
                <textarea name="message" id="message" class="w-full p-3 border rounded-lg mt-2" rows="4"></textarea>
            </div>

            <!-- Aksi untuk Instructor -->
            {% if is_instructor and course.status_course.status == 'draft' %}
                <button type="submit" name="action" value="submit_curation" class="w-full sm:w-auto bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">Submit for Curation</button>
            {% endif %}

            <!-- Aksi untuk Partner -->
            {% if is_partner and course.status_course.status == 'curation' %}
                <div class="flex gap-4 mt-4">
                    <button type="submit" name="action" value="partner_accept" class="w-full sm:w-auto bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">Accept and Submit to Superuser</button>
                    <button type="submit" name="action" value="partner_reject" class="w-full sm:w-auto bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition">Reject and Return to Instructor</button>
                </div>
            {% endif %}

            <!-- Aksi untuk Superuser -->
            {% if is_superuser and course.status_course.status == 'curation' %}
                <div class="flex gap-4 mt-4">
                    <button type="submit" name="action" value="superuser_publish" class="w-full sm:w-auto bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">Publish to Catalog</button>
                    <button type="submit" name="action" value="superuser_reject" class="w-full sm:w-auto bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition">Reject and Return to Partner</button>
                </div>
            {% endif %}
        </form>
    </div>

    <!-- Tombol Kembali -->
    <a href="#" class="bg-gray-600 text-white px-6 py-3 rounded-lg mt-4 inline-block hover:bg-gray-700 transition">Back to Catalog</a>
</section>
{% endblock %}
