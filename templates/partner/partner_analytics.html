{% extends 'home/tes.html' %}
{% load static %}

{% block content %}

<section class="bg-white border border-gray-200 p-6 rounded-lg shadow-sm hover:shadow-md transition">
      <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
        <h3 class="text-lg font-semibold text-gray-800 border-l-4 border-red-300 pl-2">Partner Analytics Dashboard</h3>
        
      </div>
    <!-- Title -->
    

    <!-- Filter & Download -->
    <form method="get" class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
        <div class="sm:col-span-2 lg:col-span-1">
            <input 
                type="text" 
                name="univ" 
                placeholder="Search Universitas" 
                value="{{ request.GET.univ }}"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition">
        </div>
        <div>
            <button type="submit" 
                    class="w-full px-5 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition shadow-sm flex items-center justify-center gap-2">
                Filter
            </button>
        </div>
        <div>
            <a href="?download=csv" 
               class="w-full px-5 py-2.5 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition shadow-sm flex items-center justify-center gap-2">
                Download CSV
            </a>
        </div>
    </form>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Chart Loop with Alpine.js Collapse -->
        {% for chart in chart_list %}
        <div x-data="{ open: true }" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <!-- Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50">
                <h5 class="text-lg font-semibold text-gray-800">{{ chart.title }}</h5>
                <button 
                    @click="open = !open"
                    class="text-sm px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 transition flex items-center gap-1">
                    <span x-show="open">Hide</span>
                    <span x-show="!open">Show</span>
                </button>
            </div>

            <!-- Collapsible Body -->
            <div x-show="open" x-collapse class="p-4">
                <div class="relative w-full h-64">
                    <canvas id="{{ chart.id }}"></canvas>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Balance Summary Card -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-sm border border-gray-200 p-6">
            <h6 class="text-lg font-semibold text-gray-800 mb-4">Balance Summary</h6>
            <div class="space-y-2 text-sm">
                <p>Average: <strong class="text-blue-700">Rp{{ balance_avg|default_if_none:0 }}</strong></p>
                <p>Min: <strong class="text-red-600">Rp{{ balance_min|default_if_none:0 }}</strong></p>
                <p>Max: <strong class="text-green-600">Rp{{ balance_max|default_if_none:0 }}</strong></p>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="{% static 'js/chart.umd.min.js' %}"></script>

<!-- Alpine.js for Collapse (CDN, ringan) -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<!-- Chart Initialization -->
<script>
document.addEventListener('alpine:init', () => {
    const chartConfigs = {
        growthChart: { type: 'line', data: {{ growth_data|safe }} },
        univChart: { type: 'bar', data: {{ univ_data|safe }} },
        revenueChart: { type: 'bar', data: {{ revenue_data|safe }} },
        monthlyRevenueChart: { type: 'line', data: {{ monthly_revenue_data|safe }} },
        completionChart: { type: 'bar', data: {{ completion_data|safe }} },
        taxChart: { type: 'bar', data: {{ tax_data|safe }} },
        iceiChart: { type: 'bar', data: {{ icei_data|safe }} },
        socialChart: { type: 'bar', data: {{ social_data|safe }} },
        authorChart: { type: 'bar', data: {{ author_data|safe }} },
        courseCountChart: { type: 'bar', data: {{ course_count_data|safe }} },
    };

    for (const [id, config] of Object.entries(chartConfigs)) {
        const ctx = document.getElementById(id);
        if (ctx) {
            new Chart(ctx, {
                type: config.type,
                data: config.data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    layout: { padding: 10 }
                }
            });
        }
    }
});
</script>
</section>
{% endblock %}