{% extends 'home/tes.html' %}
{% load extra_custom_filters %}
{% block content %}
<section class="container mx-auto px-4 py-6 bg-white shadow-md rounded-lg">
<h3 class="flex items-center text-lg font-semibold mb-4">
    <i class="bi bi-star-half mr-2"></i> Course Ratings Report
</h3>

<div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 bg-white border border-gray-300 rounded-lg">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course Run</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Average</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comments</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for course in course_rating_data %}
            <tr class="hover:bg-gray-50 transition-colors duration-150">
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ forloop.counter }}</td>
                <td class="px-4 py-3">
                    <a href="{% url 'courses:course_lms_detail' id=course.id slug=course.slug %}" target="_blank" 
                       class="text-blue-600 hover:text-blue-800 font-medium">
                        {{ course.course_name }}
                    </a>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ course.course_run|default:"-" }}</td>
                <td class="px-4 py-3 text-sm text-gray-900">
                    {{ course.status_course.get_status_display }}
                    {% if course.status_course.manual_message %}
                        
<small class="text-gray-500">{{ course.status_course.manual_message }}</small>
                    {% endif %}
                </td>

            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ course.avg_rating|floatformat:1|default:"-" }} </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ course.rating_count }}</td>
            <td class="px-4 py-3 text-sm text-gray-900">
                {% with course_ratings_details|get_item:course.id as ratings %}
                    {% if ratings %}
                        <ul class="list-disc list-inside space-y-1">
                            {% for rating in ratings %}
                                <li class="text-sm">
                                    <strong>{{ rating.user.username }} ({{ rating.rating }}):</strong> 
                                    {% if rating.comment %}
                                        "{{ rating.comment }}"
                                    {% else %}
                                        <em>No comment</em>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <em>No ratings yet</em>
                    {% endif %}
                {% endwith %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="7" class="px-4 py-3 text-center text-gray-500">No courses found or no ratings yet.</td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>

{# Pagination controls #}
{% if course_rating_data.has_other_pages %}<nav aria-label="Page navigation" class="mt-4">
    <ul class="flex justify-center space-x-0.5">
        {% if course_rating_data.has_previous %}
        <li>
            <a class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-150" 
               href="?page={{ course_rating_data.previous_page_number }}" 
               aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        {% else %}
        <li>
            <span class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-500 bg-gray-100 border border-gray-200 rounded-md cursor-not-allowed">«</span>
        </li>
        {% endif %}

    {# Show page numbers (simple version) #}
    {% for num in course_rating_data.paginator.page_range %}
      {% if num == course_rating_data.number %}
      <li>
        <span class="inline-flex items-center px-3 py-2 text-sm font-medium text-white bg-blue-500 border border-blue-500 rounded-md"> {{ num }} </span>
      </li>
      {% else %}
      <li>
        <a class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-150" 
           href="?page={{ num }}"> {{ num }} </a>
      </li>
      {% endif %}
    {% endfor %}

    {% if course_rating_data.has_next %}
    <li>
        <a class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-150" 
           href="?page={{ course_rating_data.next_page_number }}" 
           aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
        </a>
    </li>
    {% else %}
    <li>
        <span class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-500 bg-gray-100 border border-gray-200 rounded-md cursor-not-allowed">»</span>
    </li>
    {% endif %}
</ul></nav>
{% endif %}
</section>
{% endblock %}

