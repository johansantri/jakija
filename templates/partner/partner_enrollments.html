{% extends 'home/tes.html' %}
{% load extra_custom_filters %}
{% block content %}

<h2 class="text-2xl font-semibold mb-3">
  Enrolled Users ({{ direction|default:"All" }})
</h2>

<p class="text-gray-500">
  Total Enrolled Users: <strong class="font-semibold text-gray-800">{{ total_users }}</strong>
</p>

<!-- Filter Form -->
<form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
  
  <!-- Direction Filter -->
  <div>
    <label for="direction" class="block font-medium mb-1">Filter by Enrollment Direction</label>
    <select name="direction" id="direction"
      class="w-full border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500">
      <option value="">-- All --</option>
      <option value="inbound" {% if direction == 'inbound' %}selected{% endif %}>Inbound</option>
      <option value="outbound" {% if direction == 'outbound' %}selected{% endif %}>Outbound</option>
      <option value="internal" {% if direction == 'internal' %}selected{% endif %}>Internal</option>
    </select>
  </div>

  <!-- Search -->
  <div>
    <label for="search" class="block font-medium mb-1">Search by Email</label>
    <input type="text" id="search" name="search"
      value="{{ request.GET.search }}"
      placeholder="e.g. user@example.com"
      class="w-full border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500">
  </div>

  <!-- Filter Button -->
  <div>
    <label class="block mb-1 font-medium">&nbsp;</label>
    <button type="submit"
      class="w-full bg-indigo-600 text-white px-3 py-2 rounded-lg hover:bg-indigo-700 transition">
      Filter
    </button>
  </div>

  <!-- CSV Button -->
  <div>
    <label class="block mb-1 font-medium">&nbsp;</label>
    <a href="{% url 'partner:export_enrollments_csv' %}?direction={{ direction }}&search={{ request.GET.search }}"
      class="w-full block bg-green-600 text-white text-center px-3 py-2 rounded-lg hover:bg-green-700 transition">
      Download CSV
    </a>
  </div>
</form>

<!-- Table -->
<div class="overflow-x-auto">
  <table class="w-full border rounded-lg overflow-hidden">
    <thead class="bg-indigo-600 text-white text-left">
      <tr>
        <th class="p-3">ğŸ‘¤ Username</th>
        <th class="p-3">ğŸ“§ Email</th>
        <th class="p-3">ğŸ›ï¸ University</th>
        <th class="p-3 text-center">ğŸ“š Courses Enrolled</th>
      </tr>
    </thead>
    <tbody class="divide-y">

      {% for user in users %}
      <tr class="hover:bg-gray-50">
        <td class="p-3 font-semibold text-indigo-600">{{ user.username }}</td>
        <td class="p-3">{{ user.email }}</td>
        <td class="p-3">{{ user.university.name|default:"-" }}</td>

        <td class="p-3 text-center">

          <!-- Toggle Button -->
          <button type="button"
            class="px-3 py-1 text-indigo-600 border border-indigo-500 rounded-lg text-sm hover:bg-indigo-50"
            onclick="toggleCourses('{{ user.id }}')">
            Show Details
          </button>

          <!-- Collapsible -->
          <div id="courses-{{ user.id }}" class="hidden mt-3">

            {% with user_courses_map|get_item:user.id as courses %}
              {% if courses %}
              <ul class="space-y-2">
                {% for c in courses %}
                <li class="border p-3 rounded-lg">

                  <div class="font-semibold">{{ c.name }}</div>

                  <div class="text-sm text-gray-500">
                    Progress:
                    <span class="text-green-600 font-medium">{{ c.progress }}%</span> |
                    Score:
                    <span class="text-blue-600 font-medium">{{ c.score|floatformat:2 }}%</span>
                  </div>

                  <div class="mt-1 space-x-2">
                    <!-- Passed / Not -->
                    <span class="px-2 py-1 rounded text-xs
                      {% if c.passed %}
                        bg-green-600 text-white
                      {% else %}
                        bg-gray-400 text-white
                      {% endif %}
                    ">
                      {% if c.passed %}Pass{% else %}Not Yet{% endif %}
                    </span>

                    {% if not c.passed and c.eligible %}
                    <span class="px-2 py-1 rounded bg-blue-500 text-white text-xs">
                      Eligible
                    </span>
                    {% endif %}
                  </div>

                </li>
                {% endfor %}
              </ul>

              {% else %}
              <p class="text-gray-400 text-sm"><em>No courses found.</em></p>
              {% endif %}
            {% endwith %}

          </div>

        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="4" class="p-3 text-center text-gray-500">
          No users found.
        </td>
      </tr>
      {% endfor %}

    </tbody>
  </table>
</div>

<!-- Pagination -->
{% if users.has_other_pages %}
<div class="flex justify-center mt-6 space-x-2">

  {% if users.has_previous %}
  <a href="?page={{ users.previous_page_number }}&direction={{ direction }}"
    class="px-3 py-1 border rounded-lg hover:bg-gray-100">Previous</a>
  {% else %}
  <span class="px-3 py-1 border rounded-lg bg-gray-200 text-gray-400">Previous</span>
  {% endif %}

  {% for num in users.paginator.page_range %}
  <a href="?page={{ num }}&direction={{ direction }}"
    class="px-3 py-1 border rounded-lg
      {% if users.number == num %}
        bg-indigo-600 text-white
      {% else %}
        hover:bg-gray-100
      {% endif %}
    ">
    {{ num }}
  </a>
  {% endfor %}

  {% if users.has_next %}
  <a href="?page={{ users.next_page_number }}&direction={{ direction }}"
    class="px-3 py-1 border rounded-lg hover:bg-gray-100">Next</a>
  {% else %}
  <span class="px-3 py-1 border rounded-lg bg-gray-200 text-gray-400">Next</span>
  {% endif %}
</div>
{% endif %}

<!-- Toggle Script -->
<script>
function toggleCourses(id) {
    const el = document.getElementById("courses-" + id);
    el.classList.toggle("hidden");
}
</script>

{% endblock %}
