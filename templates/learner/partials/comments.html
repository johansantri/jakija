{% load learner_tags %}

<div class="comments mt-8" id="comments-section" x-data>
    <h5 class="text-xl font-bold text-gray-900 mb-2">Comments</h5>
    <p class="text-sm text-gray-600 mb-6">
        Please keep comments relevant to the discussion topic and avoid content containing hate speech, pornography, or spam.
        
    </p>
   {% if message %}
    <div id="htmx-message" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded mb-4" role="alert">
        {{ message }}
    </div>

    <script>
        setTimeout(() => {
            const msg = document.getElementById('htmx-message');
            if (msg) msg.remove();  // atau bisa pakai fade-out dengan Tailwind + transition
        }, 5000); // hilang setelah 5 detik
    </script>
    {% endif %}


    <!-- Form Komentar Utama -->
    {% if user.is_authenticated %}
        <form hx-post="{% url 'learner:add_comment' %}"
              hx-target="#comments-section"
              hx-swap="innerHTML"
              hx-on::after-request="
                  this.reset();
                  $dispatch('contentloaded');
                  // Tutup semua form reply yang terbuka
                  document.querySelectorAll('[x-data]').forEach(el => {
                      if (el.__x) el.__x.$data.replyOpen = false;
                  });
              "
              class="mb-8 bg-gray-50 rounded-xl p-5 border border-gray-200 shadow-sm">
            <input type="hidden" name="material_id" value="{{ material.id|default:'' }}">
            <input type="hidden" name="parent_id" value="">

            <div class="mb-4">
                <label for="main-comment" class="block text-sm font-medium text-gray-700 mb-2">
                    Write your feedback
                </label>
                <textarea name="comment_text"
                          id="main-comment"
                          rows="4"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none text-gray-800 placeholder-gray-400"
                          placeholder="Leave your comment..." required></textarea>
            </div>

            <div class="flex justify-end">
                <button type="submit"
                        class="inline-flex items-center gap-2 px-5 py-2.5 bg-indigo-600 text-white font-medium text-sm rounded-lg hover:bg-indigo-700 transition shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                    Post Comment
                </button>
            </div>
        </form>
    {% else %}
        <div class="bg-gray-100 border border-gray-300 text-gray-700 px-5 py-4 rounded-lg text-sm mb-8">
            Please <a href="{% url 'login' %}" class="font-medium text-indigo-600 hover:text-indigo-700 underline">log in</a> to add a comment.
        </div>
    {% endif %}

    <!-- Daftar Komentar -->
    <div class="space-y-6">
        {% for comment in comments %}
            {% include 'learner/partials/comment.html' with comment=comment user_reactions=user_reactions level=0 %}
        {% empty %}
            <p class="text-gray-500 italic text-center py-8">No comments yet. Be the first to comment!</p>
        {% endfor %}
    </div>
</div>

<!-- Optional: Global event untuk trigger setelah load komentar baru -->
<script>
    document.body.addEventListener('contentloaded', () => {
        // Bisa ditambahkan efek scroll ke komentar baru, highlight, dll
        console.log('Comments updated via HTMX');
    });
</script>