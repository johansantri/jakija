{% load learner_tags %}
{% load static %}

<main class="min-h-screen bg-gray-50" id="content-area">

{% if current_content %}

    {% if current_content.0 == 'material' %}
        {% with material=current_content.1 %}
        <article class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
            <h3 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-8 text-gray-800 leading-tight">
                {{ material.title }}
            </h3>
            <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 lg:p-12 prose prose-lg lg:prose-xl max-w-none text-gray-700">
                {{ material.description|make_iframes_responsive|safe }}
            </div>
            <div class="mt-12 lg:mt-16">
                {% include 'learner/partials/comments.html' %}
            </div>
        </article>
        {% endwith %}

    {% elif current_content.0 == 'assessment' %}
        {% with assessment=current_content.1 %}
        <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">

            {% if assessment_locked %}
            <div class="bg-yellow-50 border-l-4 border-yellow-400 rounded-2xl p-6 lg:p-10 flex flex-col lg:flex-row items-center justify-between gap-6">
                <div class="flex items-center gap-5">
                    <i class="bi bi-exclamation-triangle-fill text-5xl lg:text-7xl text-yellow-600"></i>
                    <div>
                        <h5 class="text-2xl lg:text-3xl font-bold text-gray-800">Payment Required</h5>
                        <p class="text-lg text-gray-600 mt-2">This exam requires payment before it can be started.</p>
                    </div>
                </div>
                <a href="{{ payment_required_url }}" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-8 py-4 rounded-xl text-lg lg:text-xl shadow-lg transition whitespace-nowrap">
                    Checkout Now
                </a>
            </div>
            {% else %}

                {% if ask_oras %}
                <div class="bg-white rounded-2xl shadow-xl p-6 lg:p-10">
                    <h4 class="text-2xl sm:text-3xl lg:text-4xl font-bold mb-10 text-indigo-700">Open Response Assessment</h4>
                    {% for ask_ora in ask_oras %}
                    <div class="border border-gray-200 rounded-xl p-6 lg:p-8 mb-8 bg-gray-50">
                        <h5 class="text-xl lg:text-2xl font-semibold text-gray-800">{{ ask_ora.title }}</h5>
                        <div class="my-5 prose prose-indigo">{{ ask_ora.question_text|safe }}</div>
                        <p class="text-sm lg:text-base text-gray-600 mb-5">Deadline: {{ ask_ora.response_deadline|date:"d M Y H:i" }}</p>
                        {% if askora_can_submit|dict_get:ask_ora.id %}
                        <form method="POST" hx-post="{% url 'learner:submit_answer_askora_new' ask_ora.id %}" hx-target="#content-area" hx-swap="innerHTML" enctype="multipart/form-data" class="space-y-6">
                            {% csrf_token %}
                            <textarea name="answer_text" rows="8" required class="w-full border border-gray-300 rounded-lg p-4 text-base lg:text-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Tulis jawaban Anda di sini..."></textarea>
                            <input type="file" name="answer_file" class="block w-full text-sm lg:text-base">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow transition text-base lg:text-lg">
                                Submit Answer
                            </button>
                        </form>
                        {% else %}
                        <div class="bg-red-100 border border-red-300 text-red-700 px-6 py-4 rounded-lg font-medium text-base lg:text-lg">
                            Submission period has closed.
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if is_quiz and is_started and not is_expired %}
                <div class="sticky top-0 bg-white shadow-2xl z-50 p-4 lg:p-6 mb-10 rounded-2xl border border-gray-200">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        <span class="text-lg lg:text-xl font-semibold text-gray-700">
                            Remaining Time: <span id="timer-countdown" class="text-3xl lg:text-4xl font-bold text-red-600">{{ remaining_time }}</span>s
                        </span>
                        <span id="progress-percent" class="text-base lg:text-lg font-medium text-gray-600">100%</span>
                    </div>
                    <div class="w-full bg-gray-300 rounded-full h-8 lg:h-10 mt-3 overflow-hidden">
                        <div id="timer-progress" class="bg-gradient-to-r from-blue-500 to-blue-700 h-full rounded-full transition-all duration-1000 flex items-center justify-end pr-4">
                            <span class="text-white font-bold text-sm lg:text-base">100%</span>
                        </div>
                    </div>
                </div>

                <form id="quiz-form" hx-post="{% url 'learner:submit_assessment_new' assessment.id %}" hx-target="#content-area" hx-swap="innerHTML" method="POST" class="space-y-10">
                    {% csrf_token %}
                    {% for question in assessment.questions.all|shuffled %}
                    <div class="bg-white p-6 lg:p-10 rounded-2xl shadow-xl border border-gray-200">
                        <h5 class="text-xl sm:text-2xl lg:text-3xl font-semibold mb-8 text-gray-800 leading-tight">
                            {{ forloop.counter }}. {{ question.text }}
                        </h5>
                        <div class="space-y-5">
                            {% for choice in question.choices.all|shuffled %}
                            {% with answered=answered_questions|get_item:question.id %}
                            <label class="flex items-start gap-5 cursor-pointer p-5 lg:p-6 rounded-xl hover:bg-gray-50 transition border border-gray-200">
                                <input type="radio" name="answers_{{ question.id }}" value="{{ choice.id }}"
                                       class="mt-1 w-5 h-5 lg:w-6 lg:h-6 text-indigo-600 focus:ring-indigo-500"
                                       {% if answered and answered.choice.id == choice.id %}checked{% endif %}>
                                <span class="text-base sm:text-lg lg:text-xl text-gray-700 leading-relaxed flex-1">{{ choice.text }}</span>
                            </label>
                            {% endwith %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}

                    <div class="text-center mt-16">
                        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold text-xl sm:text-2xl lg:text-3xl px-12 lg:px-20 py-5 lg:py-7 rounded-xl shadow-2xl transition transform hover:scale-105">
                            Submit All Answers
                        </button>
                    </div>
                </form>

                <script>
                (function () {
                    const timerEl = document.getElementById('timer-countdown');
                    const progress = document.getElementById('timer-progress');
                    const percentEl = document.getElementById('progress-percent');
                    if (!timerEl) return;
                    let total = parseInt(timerEl.textContent);
                    let left = total;
                    const iv = setInterval(() => {
                        left--;
                        const pct = Math.round((left / total) * 100);
                        timerEl.textContent = left;
                        progress.style.width = pct + '%';
                        percentEl.textContent = pct + '%';
                        progress.querySelector('span').textContent = pct + '%';
                        if (pct <= 25) progress.classList.replace('from-blue-500', 'from-red-500');
                        else if (pct <= 50) progress.classList.replace('from-blue-500', 'from-yellow-500');
                        if (left <= 0) {
                            clearInterval(iv);
                            document.querySelectorAll('#quiz-form input[type=radio]').forEach(i => i.disabled = true);
                            htmx.trigger('#quiz-form', 'submit');
                        }
                    }, 1000);
                })();
                </script>
                {% endif %}

                {% if is_lti and lti_tool %}
                <div class="text-center py-24 lg:py-32 bg-gradient-to-b from-indigo-50 to-white rounded-3xl">
                    <h4 class="text-4xl sm:text-5xl lg:text-6xl font-bold mb-8 text-gray-800">{{ lti_tool.tool_name }}</h4>
                    <p class="text-lg lg:text-xl text-gray-600 mb-12 max-w-2xl mx-auto">Klik tombol di bawah untuk membuka alat eksternal.</p>
                    <form action="{% url 'learner:lti_consume_course' assessment.id %}" method="get" target="_blank">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-2xl lg:text-4xl px-20 lg:px-32 py-8 lg:py-12 rounded-xl shadow-2xl transition transform hover:scale-105">
                            Launch LTI Tool
                        </button>
                    </form>
                </div>
                {% endif %}

                {% if is_quiz and not is_started and not assessment_locked %}
                <div class="text-center py-32 lg:py-40 bg-gradient-to-br from-purple-50 to-indigo-50 rounded-3xl">
                    <h3 class="text-4xl sm:text-5xl lg:text-6xl font-bold mb-10 text-gray-800">{{ assessment.title }}</h3>
                    <p class="text-xl lg:text-2xl text-gray-600 mb-16">Siap untuk memulai kuis?</p>
                    <form method="POST" hx-post="{% url 'learner:start_assessment' assessment.id %}" hx-target="#content-area" hx-swap="innerHTML">
                        {% csrf_token %}
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold text-3xl lg:text-5xl px-20 lg:px-32 py-10 lg:py-16 rounded-xl shadow-2xl transition transform hover:scale-110">
                            Start Quiz Now
                        </button>
                    </form>
                </div>
                {% endif %}

            {% endif %}
        </div>
        {% endwith %}
    {% endif %}

    <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 mt-16 lg:mt-24">
        {% include 'learner/partials/navigation.html' %}
    </div>

{% else %}
    <div class="text-center py-32 lg:py-48">
        <p class="text-2xl lg:text-3xl text-gray-500">Please select a material or assessment from the sidebar.</p>
    </div>
{% endif %}

</main>

<!-- Welcome Modal (tetap sama, sudah responsif) -->
{% if messages %}
<div class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" id="welcomeModal">
    <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full overflow-hidden">
        <div class="p-8 text-center">
            <button onclick="document.getElementById('welcomeModal').remove()" class="float-right text-gray-500 hover:text-gray-700">
                <i class="bi bi-x-lg text-3xl"></i>
            </button>
            {% for message in messages %}
                <div class="prose prose-lg max-w-none text-gray-700">{{ message|safe }}</div>
            {% endfor %}
        </div>
        <div class="bg-gray-50 px-8 py-6 flex flex-col sm:flex-row gap-4">
            <button onclick="window.location.href='{% url 'courses:course_lms_detail' course.id course.slug %}'"
                    class="flex-1 py-4 border-2 border-gray-300 rounded-xl font-semibold hover:bg-gray-100 transition text-base lg:text-lg">
                View Course Details
            </button>
            <button onclick="document.getElementById('welcomeModal').remove()"
                    class="flex-1 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold hover:from-indigo-700 hover:to-purple-700 transition shadow-lg text-base lg:text-lg">
                Start Learning!
            </button>
        </div>
    </div>
</div>
{% endif %}

<script src="{% static 'js/pingSession.js' %}"></script>