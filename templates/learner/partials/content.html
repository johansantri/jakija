{% load learner_tags %}
{% load static %}

<main class="bg-white border border-gray-200 p-4 sm:p-6 lg:p-8 rounded-xl shadow-sm mt-6 mx-2 sm:mx-0" id="content-area">

{% if current_content %}

    {% if current_content.0 == 'material' %}
        {% with material=current_content.1 %}
        <article class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
            
             <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                <h3 class="text-lg font-semibold text-gray-800 border-l-4 border-red-300 pl-2">{{ material.title }} </h3>
                
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 lg:p-12 prose prose-lg lg:prose-xl max-w-none text-gray-700">
                {{ material.description|make_iframes_responsive|safe }}
            </div>
            <div class="mt-12 lg:mt-16">
                {% include 'learner/partials/comments.html' %}
            </div>
        </article>
        {% endwith %}

    {% elif current_content.0 == 'assessment' %}
        {% with assessment=current_content.1 %}
        <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">

            {% if assessment_locked %}
            <div class="bg-yellow-50 border-l-4 border-yellow-400 rounded-2xl p-6 lg:p-10 flex flex-col lg:flex-row items-center justify-between gap-6">
                <div class="flex items-center gap-5">
                    <i class="bi bi-exclamation-triangle-fill text-5xl lg:text-7xl text-yellow-600"></i>
                    <div>
                        <h5 class="text-2xl lg:text-3xl font-bold text-gray-800">Payment Required</h5>
                        <p class="text-lg text-gray-600 mt-2">This exam requires payment before it can be started.</p>
                    </div>
                </div>
                <a href="{{ payment_required_url }}" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-8 py-4 rounded-xl text-lg lg:text-xl shadow-lg transition whitespace-nowrap">
                    Checkout Now
                </a>
            </div>
            {% else %}

              

            {% if ask_oras %}
                <div class="bg-white rounded-2xl shadow-xl p-8 lg:p-12 mb-12">
                   
                    <h4 class="text-3xl font-bold text-indigo-700 mb-4">Open Response Assessment</h4>
                    <p class="text-lg text-gray-600 mb-10">Work on the task below and wait for a peer review from your classmates.</p>

                    {% for ask_ora in ask_oras %}
                    <div class="border border-gray-200 rounded-2xl p-8 mb-12 bg-gradient-to-br from-gray-50 to-white">
                        
                        <h5 class="text-2xl font-bold text-gray-800 mb-4">{{ ask_ora.title|default:"Essay Assignment" }}</h5>
                        <div class="prose prose-lg mb-6 text-gray-700">{{ ask_ora.question_text|safe }}</div>

                        <div class="flex items-center gap-3 text-gray-600 mb-8">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-semibold">Deadline:</span>
                            <span class="font-bold text-red-600">{{ ask_ora.response_deadline|date:"d M Y H:i" }}</span>
                        </div>

                        {# 1. BELUM SUBMIT & MASIH BOLEH SUBMIT #}
                        {% if askora_can_submit|dict_get:ask_ora.id %}
                            <div class="bg-blue-50 border-2 border-blue-300 rounded-2xl p-8">
                                <h6 class="text-xl font-bold text-blue-900 mb-6">Submit Your Answer</h6>
                                <form method="POST"
                                    hx-post="{% url 'learner:submit_answer_askora_new' ask_ora.id %}"
                                    hx-target="#content-area"
                                    hx-swap="innerHTML"
                                    enctype="multipart/form-data"
                                    class="space-y-6">
                                    {% csrf_token %}
                                    <textarea name="answer_text" rows="8" required
                                            class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-200 focus:border-blue-500"
                                            placeholder="Tulis jawaban Anda di sini..."></textarea>
                                    <input type="file" name="answer_file"
                                        class="block w-full text-sm file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                                    <button type="submit"
                                            class="w-full px-8 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold text-xl rounded-xl shadow-lg transform hover:scale-105 transition">
                                        Submit Answer Now
                                    </button>
                                </form>
                            </div>

                        {# 2. SUDAH SUBMIT â†’ Tampilkan bukti jawaban #}
                        {% elif user_submissions %}
                            {% with submission=user_submissions|first %}
                                {% if submission.askora.id == ask_ora.id %}
                                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-400 rounded-2xl p-6 md:p-8 mb-8 w-full max-w-full">

                                    <div class="flex flex-col sm:flex-row sm:items-center gap-4 sm:gap-5 mb-4">
                                        <svg class="w-10 h-10 sm:w-12 sm:h-12 text-green-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                clip-rule="evenodd"></path>
                                        </svg>

                                        <div class="w-full break-words">
                                            <p class="text-xl sm:text-2xl font-bold text-green-800">answer successfully sent!</p>
                                            <p class="text-base sm:text-lg">do not change it anymore.</p>
                                        </div>
                                    </div>

                                    <p class="text-green-700 mt-2 sm:mt-4 text-sm sm:text-base break-words">
                                        Submitted on:
                                        <strong>{{ submission.submitted_at|date:"d M Y H:i" }}</strong>
                                    </p>

                                    {% if submission.answer_text %}
                                    <div class="bg-white rounded-xl p-4 sm:p-6 mt-4 sm:mt-6 border overflow-x-auto break-words">
                                        <p class="font-bold text-gray-700 mb-3">your answer:</p>
                                        <div class="prose text-gray-700 max-w-full break-words">
                                            {{ submission.answer_text|linebreaks }}
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if submission.answer_file %}
                                    <a href="{{ submission.answer_file.url }}" target="_blank"
                                        class="inline-flex items-center justify-center gap-3 mt-6 px-6 sm:px-8 py-3 sm:py-4 w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition">
                                        Download 
                                    </a>
                                    {% endif %}

                                </div>
                                {% endif %}
                            {% endwith %}


                        {# 3. DEADLINE LEWAT & BELUM SUBMIT #}
                        {% else %}
                            <div class="bg-red-50 border-2 border-red-400 rounded-2xl p-8">
                                <div class="flex items-center gap-5">
                                    <svg class="w-12 h-12 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div>
                                        <p class="text-2xl font-bold text-red-800">Submission has been closed</p>
                                        <p class="text-lg">You did not submit the assignment on time.</p>
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                    </div>
                    {% endfor %}
                </div>
            {% endif %}


            {# ==================== STATUS PEER REVIEW (Hanya muncul jika sudah submit) ==================== #}
            {% if user_submissions %}
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl shadow-xl p-8 lg:p-12 mb-12">
                    <h4 class="text-3xl font-bold text-purple-700 mb-8 flex items-center gap-4">
                        <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17 9V7a5 5 0 00-10 0v2H5a2 2 0 00-2 2v6a2 2 0 002 2h14a2 2 0 002-2v-6a2 2 0 00-2-2h-2zM9 7a3 3 0 016 0v2H9V7z"></path>
                        </svg>
                        Peer Review Status
                    </h4>

                    <div class="grid md:grid-cols-3 gap-8 mb-10">
                        <div class="bg-white rounded-xl p-6 text-center shadow">
                            <p class="text-5xl font-black text-purple-600">{{ peer_review_stats.distinct_reviewers|default:0 }}</p>
                            <p class="text-lg font-semibold text-gray-700 mt-2">Your Answer Has Been Reviewed</p>
                        </div>
                        <div class="bg-white rounded-xl p-6 text-center shadow">
                            <p class="text-5xl font-black text-blue-600">{{ submissions|length }}</p>
                            <p class="text-lg font-semibold text-gray-700 mt-2">Answers You Need to Review</p>
                        </div>
                        <div class="bg-white rounded-xl p-6 text-center shadow">
                            <p class="text-5xl font-black {% if peer_review_stats.avg_score >= 4 %}text-green-600{% else %}text-orange-600{% endif %}">
                                {{ peer_review_stats.avg_score|default:"-" }}/5
                            </p>
                            <p class="text-lg font-semibold text-gray-700 mt-2">Average Score from Peers</p>
                        </div>
                    </div>

                    {# Jika masih ada yang harus direview #}
                    {% if can_review and submissions %}
                        <div class="bg-yellow-50 border-2 border-yellow-400 rounded-2xl p-8 mb-8">
                            <p class="text-xl font-bold text-yellow-900 flex items-center gap-3">
                                There are {{ submissions|length }} answers from friends that you have not reviewed!
                            </p>
                            <p class="text-yellow-800 mt-2">Please review below so your score can also be released.</p>
                        </div>
                    {% endif %}

                    {# Jika sudah review semua #}
                    {% if not can_review and peer_review_stats.distinct_reviewers > 0 %}
                        <div class="bg-green-50 border-2 border-green-400 rounded-2xl p-8">
                            <p class="text-xl font-bold text-green-900 flex items-center gap-3">
                                You have reviewed all available answers!
                            </p>
                            <p class="text-green-800 mt-2">Now waiting for others to review your answers.</p>
                        </div>
                    {% endif %}

                    {# Jika belum ada yang review (masih awal) #}
                    {% if peer_review_stats.distinct_reviewers == 0 %}
                        <div class="bg-orange-50 border-2 border-orange-400 rounded-2xl p-8">
                            <p class="text-xl font-bold text-orange-900">Waiting for review from friends...</p>
                            <p class="text-orange-800 mt-2">Final score will appear after there is at least 1 review.</p>
                        </div>
                    {% endif %}
                </div>
            {% endif %}


            {# ==================== BAGIAN REVIEW JAWABAN TEMAN ==================== #}
            {% if can_review and submissions %}
                <div class="bg-white rounded-2xl shadow-xl p-8 lg:p-12">
                    <h4 class="text-3xl font-bold text-purple-700 mb-8">Review Jawaban Teman ({{ submissions|length }})</h4>

                    {% for submission in submissions %}
                    <div class="border border-purple-200 rounded-2xl p-8 mb-10 bg-purple-50">
                        <div class="flex justify-between items-start mb-6">
                            <h5 class="text-2xl font-bold text-purple-800">{{ submission.askora.title }}</h5>
                            <span class="text-purple-600 font-medium">
                                oleh {{ submission.user.get_full_name|default:submission.user.username }}
                            </span>
                        </div>

                        {% if submission.answer_text %}
                        <div class="bg-white rounded-xl p-6 mb-6 border">{{ submission.answer_text|linebreaks }}</div>
                        {% endif %}

                        {% if submission.answer_file %}
                        <a href="{{ submission.answer_file.url }}" target="_blank" class="text-purple-600 hover:underline mb-6 inline-block">
                            Download Lampiran
                        </a>
                        {% endif %}

                        <form method="POST"
                            hx-post="{% url 'learner:submit_peer_review_new' submission.id %}"
                            hx-target="#content-area"
                            hx-swap="innerHTML"
                            class="space-y-6 mt-8">
                            {% csrf_token %}

                            <div>
                                <label class="block text-xl font-bold text-gray-800 mb-4">Beri Nilai (1-5)</label>
                                <select name="score" required class="w-full px-6 py-4 text-lg border-2 border-purple-300 rounded-xl focus:ring-4 focus:ring-purple-200">
                                    <option value="">Pilih nilai...</option>
                                    <option value="5">5 - Sangat Baik</option>
                                    <option value="4">4 - Baik</option>
                                    <option value="3">3 - Cukup</option>
                                    <option value="2">2 - Kurang</option>
                                    <option value="1">1 - Sangat Kurang</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-xl font-bold text-gray-800 mb-4">Komentar (Opsional)</label>
                                <textarea name="comment" rows="4"
                                        class="w-full px-6 py-4 border-2 border-purple-300 rounded-xl focus:ring-4 focus:ring-purple-200"
                                        placeholder="Beri masukan yang membangun..."></textarea>
                            </div>

                            <button type="submit"
                                    class="inline-flex items-center gap-3 mt-6 px-8 py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition">
                                Kirim Review Ini
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}

                <!-- IN-VIDEO QUIZ: VERSI ULTIMATE (Video.js + GSAP + Sound + Score + Super Cantik) -->
                {% if is_video_quiz and video %}
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                        <h3 class="text-lg font-semibold text-gray-800 border-l-4 border-red-300 pl-2">{{ video.title }} </h3>
                        
                    </div>
                 
                        <style>
                            .quiz-overlay{
                                position:fixed; inset:0;
                                background:rgba(0,0,0,0.85);
                                backdrop-filter:blur(15px);
                                opacity:0; pointer-events:none;
                                transition:opacity .35s ease;
                                z-index:50;
                                display:flex; align-items:center; justify-content:center;
                                padding:1.5rem; overflow-y:auto;
                            }
                            .quiz-overlay.active{
                                opacity:1; pointer-events:all;
                            }

                            .quiz-card{
                                background:rgba(255,255,255,0.96);
                                border-radius:1.75rem;
                                padding:2rem;
                                width:100%; max-width:480px;
                                box-shadow:0 25px 60px -12px rgba(0,0,0,0.45);
                                transform:scale(.9); opacity:0;
                            }

                            /* Buttons */
                            .quiz-option{
                                @apply w-full p-4 text-left rounded-xl font-medium transition-all cursor-pointer;
                                background:#f8fafc;
                                border:2px solid transparent;
                            }
                            .quiz-option:hover{
                                background:#eef2ff;
                                border-color:#c7d2fe;
                                transform:translateY(-2px);
                                box-shadow:0 6px 16px rgba(0,0,0,0.15);
                            }

                            .quiz-btn-true{
                                @apply w-full p-5 text-2xl font-bold rounded-xl text-white transition;
                                background:#10b981;
                            }
                            .quiz-btn-true:hover{ background:#059669; }

                            .quiz-btn-false{
                                @apply w-full p-5 text-2xl font-bold rounded-xl text-white transition;
                                background:#ef4444;
                            }
                            .quiz-btn-false:hover{ background:#dc2626; }

                            .finish-card-icon{
                                filter: drop-shadow(0px 8px 12px rgba(255,200,0,0.7));
                            }
                        </style>
                    
                        <div class="relative w-full max-w-10xl shadow-2xl rounded-2xl overflow-hidden bg-black">
                            
                            <video id="myVideo" data-id="{{ video.id }}" data-assessment="{{ assessment.id }}" class="w-full" controls preload="auto">
                                <source src="{{ video.file.url }}" type="video/mp4">
                                browser not suport.
                            </video>

                            <div class="absolute top-4 left-4 bg-black/70 backdrop-blur px-5 py-3 rounded-full flex items-center gap-3 z-50">
                                <i class="fas fa-trophy text-yellow-400 text-xl"></i>
                                <span id="scoreDisplay" class="font-bold text-xl">0 / 0</span>
                            </div>

                            <div id="quizOverlay" class="quiz-overlay">
                                <div class="quiz-card">
                                    <h2 id="questionText" class="text-xl md:text-2xl font-bold text-center mb-6 leading-relaxed"></h2>
                                    <div id="optionsContainer" class="space-y-4 mb-6"></div>
                                    <div id="explanation" class="p-4 bg-green-100 rounded-xl text-green-800 font-medium hidden"></div>
                                    <button id="nextButton" class="w-full mt-6 bg-red-500 hover:bg-red-600 text-white font-bold py-5 rounded-full text-lg shadow-lg transition transform hover:scale-105">
                                        Continue Video
                                    </button>
                                </div>
                            </div>
                        </div>

                        <audio id="correctSound">
                        <source src="{% static 'sounds/correct-156911.mp3' %}" type="audio/mp3">
                        </audio>
                        <audio id="wrongSound">
                        <source src="{% static 'sounds/error-mistake-sound-effect-incorrect-answer-437420.mp3' %}" type="audio/mp3">
                        </audio>
          
                        <script>
                            const quizzes = {{ quizzes_json|safe }};
                            let currentQuiz = 0;
                            let score = 0;
                            let answeredQuizzes = {};

                            function getCSRFToken() {
                                const name = "csrftoken=";
                                const cookies = document.cookie.split(';');
                                for (let cookie of cookies) {
                                    cookie = cookie.trim();
                                    if (cookie.startsWith(name)) {
                                        return cookie.substring(name.length);
                                    }
                                }
                                return null;
                            }


                            // console.log(getCSRFToken());  // Cek apakah token CSRF diambil dengan benar





                            const video = document.getElementById('myVideo');
                            const overlay = document.getElementById('quizOverlay');
                            const quizCard = document.querySelector('.quiz-card');
                            const questionText = document.getElementById('questionText');
                            const optionsContainer = document.getElementById('optionsContainer');
                            const nextButton = document.getElementById('nextButton');
                            const explanation = document.getElementById('explanation');
                            const scoreDisplay = document.getElementById('scoreDisplay');

                            const result = JSON.parse('{{ result_json|default:"null"|escapejs }}');

                            // Jika user pernah submit sebelumnya
                            if(result){
                                score = result.score || 0;
                                if(result.answers){
                                    Object.keys(result.answers).forEach(index => {
                                        answeredQuizzes[index] = {
                                            answered: true,
                                            correct: result.answers[index].correct,
                                            userAnswer: result.answers[index].answer,
                                            shown: false // overlay belum ditampilkan
                                        };
                                    });
                                }
                                updateScoreDisplay();
                            }

                            // Fungsi main
                            function playSound(correct){
                                const s = correct ? document.getElementById('correctSound') : document.getElementById('wrongSound');
                                s.pause(); s.currentTime=0; s.play().catch(()=>{});
                            }

                            function updateScoreDisplay(){
                                const answeredCount = Object.keys(answeredQuizzes).length;
                                scoreDisplay.textContent = `${score} / ${answeredCount}`;
                            }

                            // Tampilkan quiz
                            function showQuiz(index){
                                const q = quizzes[index];
                                video.pause();
                                overlay.classList.add('active');
                                gsap.to(quizCard, {scale:1, opacity:1, duration:0.6, ease:"back.out(1.7)"});
                                questionText.textContent = q.question;
                                optionsContainer.innerHTML = '';
                                explanation.classList.add('hidden');
                                nextButton.classList.add('hidden');

                                const alreadyAnswered = answeredQuizzes[index] || {answered:false, correct:false};

                                // Jika sudah dijawab sebelumnya, tampilkan jawaban disable
                                if(alreadyAnswered.answered){
                                    if(q.type === "multiple-choice"){
                                        q.options.forEach((opt,i)=>{
                                            const b = document.createElement('button');
                                            b.className = "w-full p-4 text-center bg-gray-100 rounded-xl font-medium transition text-base md:text-lg";
                                            b.textContent = opt;
                                            if(i === q.correct) b.classList.add("bg-green-500");
                                            if(alreadyAnswered.userAnswer === i && !alreadyAnswered.correct) b.classList.add("bg-red-500","text-white");
                                            b.disabled = true;
                                            optionsContainer.appendChild(b);
                                        });
                                    } else if(q.type === "true-false"){
                                        ["incorrect","correct"].forEach(label=>{
                                            const btn = document.createElement('button');
                                            btn.className = `w-full p-6 text-2xl font-bold rounded-xl ${label==="correct"?"bg-green-500 hover:bg-green-600":"bg-red-500 hover:bg-red-600"} text-white`;
                                            btn.textContent = label;
                                            btn.disabled = true;
                                            if(alreadyAnswered.userAnswer === label && !alreadyAnswered.correct){
                                                btn.classList.remove("bg-green-500","bg-red-500");
                                                btn.classList.add("bg-red-500","text-white");
                                            }
                                            optionsContainer.appendChild(btn);
                                        });
                                    } else if(q.type==="fill-blank" || q.type==="es"){
                                        const input = document.createElement('input');
                                        input.type="text";
                                        input.value = alreadyAnswered.userAnswer || "";
                                        input.disabled = true;
                                        input.className = "w-full p-5 text-xl text-center border-4 border-gray-300 rounded-xl outline-none " + (alreadyAnswered.correct?"bg-green-500 text-white":"bg-red-500 text-white");
                                        optionsContainer.appendChild(input);
                                    } else if(q.type==="drag-and-drop"){
                                        const drop = document.createElement('div');
                                        drop.className = "border-4 border-dashed border-green-500 rounded-2xl h-32 mb-6 flex items-center justify-center text-lg font-bold";
                                        drop.textContent = alreadyAnswered.userAnswer || "Answer: " + q.correct;
                                        optionsContainer.appendChild(drop);
                                    }

                                    explanation.textContent = q.explanation || "";
                                    explanation.classList.remove('hidden');
                                    nextButton.classList.remove('hidden');
                                    return; // jangan buat tombol submit lagi
                                }

                                // Jika belum dijawab, tampilkan tombol submit (normal)
                                function handleAnswer(correct, el){
                                    if(alreadyAnswered.answered) return;
                                    alreadyAnswered.answered = true;
                                    alreadyAnswered.correct = correct;
                                    answeredQuizzes[index] = alreadyAnswered;
                                    if(correct) score++;
                                    playSound(correct);
                                    if(el) el.classList.add(correct ? "bg-green-500" : "bg-red-500","text-white");
                                    explanation.textContent = q.explanation || "";
                                    explanation.classList.remove('hidden');
                                    nextButton.classList.remove('hidden');
                                    updateScoreDisplay();
                                }

                                if(q.type==="multiple-choice"){
                                    q.options.forEach((opt,i)=>{
                                        const b = document.createElement('button');
                                        b.className = "w-full p-4 text-center bg-blue-100 hover:bg-gray-200 rounded-xl font-medium transition text-base md:text-lg";
                                        b.textContent = opt;
                                        b.onclick=()=>handleAnswer(i===q.correct,b);
                                        optionsContainer.appendChild(b);
                                    });
                                } else if(q.type === "true-false"){
                                    const trueButton = document.createElement('button');
                                    trueButton.className = "w-full p-6 text-2xl font-bold rounded-xl bg-red-500 hover:bg-red-600 text-white";
                                    trueButton.textContent="incorrect";

                                    const falseButton = document.createElement('button');
                                    falseButton.className = "w-full p-6 text-2xl font-bold rounded-xl bg-green-500 hover:bg-green-600 text-white";
                                    falseButton.textContent="correct";

                                    const correctAnswer = String(q.correct).toLowerCase() === "true" || String(q.correct).toLowerCase() === "correct";
                                    trueButton.onclick = () => handleAnswer(correctAnswer === true, trueButton);
                                    falseButton.onclick = () => handleAnswer(correctAnswer === false, falseButton);

                                    optionsContainer.appendChild(trueButton);
                                    optionsContainer.appendChild(falseButton);
                                } else if(q.type==="fill-blank" || q.type==="es"){
                                    const input = document.createElement('input');
                                    input.type="text"; input.autofocus=true; input.placeholder="Type your answer...";
                                    input.className = "w-full p-5 text-xl text-center border-4 border-gray-300 rounded-xl focus:border-emerald-500 outline-none";
                                    const sub = document.createElement('button');
                                    sub.textContent="Submit"; sub.className = "mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-full";
                                    sub.onclick = ()=>handleAnswer(input.value.trim().toLowerCase()===q.correct.toLowerCase(),input);
                                    input.addEventListener("keydown", e=> e.key==="Enter" && sub.click());
                                    optionsContainer.appendChild(input); 
                                    optionsContainer.appendChild(sub);
                                } else if(q.type==="drag-and-drop"){
                                    const drop=document.createElement('div');
                                    drop.className="border-4 border-dashed border-green-500 rounded-2xl h-32 mb-6 flex items-center justify-center text-lg font-bold";
                                    drop.textContent="Drop here";
                                    drop.ondragover=e=>e.preventDefault();
                                    drop.ondrop=e=>{ e.preventDefault(); handleAnswer(e.dataTransfer.getData("text")===q.correct,drop); };
                                    optionsContainer.appendChild(drop);

                                    const items=document.createElement('div'); items.className="grid grid-cols-2 gap-4";
                                    q.items.forEach(item=>{
                                        const el=document.createElement('div');
                                        el.className="bg-green-600 text-white p-5 rounded-xl text-center cursor-move select-none text-base md:text-lg";
                                        el.textContent=item; el.draggable=true;
                                        el.ondragstart=e=>e.dataTransfer.setData("text",item);
                                        items.appendChild(el);
                                    });
                                    optionsContainer.appendChild(items);
                                }
                            }

                            // Tombol Next
                            nextButton.onclick=()=>{
                                overlay.classList.remove('active');
                                currentQuiz++;
                                if(currentQuiz<quizzes.length) video.play();
                                else endQuiz();
                            };

                            // Simpan hasil dan tampilkan UI akhir
                            // Simpan hasil dan tampilkan UI akhir
                            // Fungsi untuk melanjutkan menonton video
                            // Fungsi untuk melanjutkan menonton video dan menyembunyikan overlay
                            function continueWatching() {
                            const video = document.getElementById('myVideo');
                            const overlay = document.getElementById('quizOverlay');
                            const quizCard = document.querySelector('.quiz-card');

                            if (video.paused) {
                                video.play();  // Lanjutkan video jika belum selesai
                            }

                            // Sembunyikan overlay dan quiz card
                            overlay.classList.remove('active'); // Menghapus class 'active' untuk menyembunyikan overlay
                            quizCard.classList.add('hidden');   // Menambahkan class 'hidden' untuk menyembunyikan quiz card
                            }


                            function endQuiz() {
                            const csrfToken = getCSRFToken();
                            //console.log("CSRF Token:", csrfToken); // Cek token CSRF yang diambil
                            const videoEl = document.getElementById("myVideo");

                            // ðŸ”¥ JANGAN LUPA INI
                            const assessmentId = videoEl.dataset.assessment;

                            // console.log("Assessment ID:", assessmentId);
                            overlay.classList.add('active');
                            fetch(`/video/${videoEl.dataset.id}/save-result/${assessmentId}/`, {
                                method: "POST",
                                credentials: "same-origin", 
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": getCSRFToken(),
                                },
                                body: JSON.stringify({
                                    score: score,
                                    total: quizzes.length,
                                    answers: answeredQuizzes
                                })
                            })
                            .then(res => {
                                if (!res.ok) {
                                    return res.text().then(text => {throw new Error(text)});
                                }
                                return res.json();
                            })
                            .then(data => {
                                console.log("Saved:", data);
                            })
                            .catch(error => {
                                console.error("Request failed:", error);
                                alert('CSRF Token Error or server issue. ' + error.message);
                            });

                            quizCard.innerHTML = `
                                <div class="text-center py-12">
                                    <i class="fas fa-trophy text-8xl text-yellow-400 mb-6"></i>
                                    <h2 class="text-4xl font-bold mb-4">Done !</h2>
                                    <p class="text-6xl font-black text-green-400">${score}/${quizzes.length}</p>
                                    <button onclick="continueWatching()" class="mt-8 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-5 rounded-full text-xl">Continue Watching Until Finished</button>
                                </div>`;
                            }





                            // Event video timeupdate
                            video.addEventListener('timeupdate', ()=>{
                                quizzes.forEach((q,index)=>{
                                    if(video.currentTime >= q.time && !answeredQuizzes[index]?.shown){
                                        answeredQuizzes[index] = answeredQuizzes[index] || {};
                                        answeredQuizzes[index].shown = true;
                                        showQuiz(index);
                                    }
                                });
                            });
                        </script>    
                {% endif %}



                            <!-- AKHIR IN-VIDEO QUIZ ULTIMATE -->

                {% if is_quiz %}
                    {% if is_started %}

                        {% if is_expired %}

                            <!-- ALERT - Assessment Period Ended -->
                            

                                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                                <h3 class="text-lg font-semibold text-gray-800 border-l-4 border-red-300 pl-2">The assessment period has ended. </h3>
                                
                            </div>
                            
                            <!-- REVIEW MODE -->
                            {% for question in assessment.questions.all %}
                                {% with answer=answered_questions|get_question_answer:question.id %}

                                    <div class="p-6 mb-6 rounded-2xl shadow-lg border 
                                        {% if answer and answer.choice.is_correct %}
                                            border-green-500
                                        {% else %}
                                            border-red-500
                                        {% endif %}
                                    ">

                                        <h3 class="text-xl font-semibold mb-4 text-gray-800">
                                            {{ question.text|safe }}
                                        </h3>

                                        <ul class="space-y-3">

                                            {% for choice in question.choices.all %}

                                                <li class="p-4 rounded-xl border 
                                                    {% if choice.is_correct %}
                                                        bg-green-100 border-green-300
                                                    {% elif answer and answer.choice.id == choice.id %}
                                                        bg-red-100 border-red-300
                                                    {% else %}
                                                        bg-gray-50 border-gray-200
                                                    {% endif %}
                                                ">

                                                    <div class="flex items-center justify-between">
                                                        <span class="text-gray-700">{{ choice.text|safe }}</span>

                                                        <div class="flex space-x-2">

                                                            {% if choice.is_correct %}
                                                                <span class="px-2 py-1 text-xs font-semibold bg-green-600 text-white rounded-full">
                                                                    Correct
                                                                </span>
                                                            {% endif %}

                                                            {% if answer and answer.choice.id == choice.id %}
                                                                <span class="px-2 py-1 text-xs font-semibold bg-blue-600 text-white rounded-full">
                                                                    Your Response
                                                                </span>
                                                            {% endif %}

                                                        </div>
                                                    </div>

                                                </li>

                                            {% endfor %}
                                        </ul>
                                    </div>

                                {% endwith %}
                            {% endfor %}

                        {% else %}

                            <!-- TIMER SECTION -->
                            <div class="sticky top-0 bg-white shadow-xl z-40 p-4 mb-6 rounded-2xl border border-gray-200">

                                <div class="flex justify-between items-center mb-3">
                                    <span class="text-gray-700 font-medium">
                                        Remaining Time:
                                        <span id="timer-countdown"
                                            class="text-3xl font-bold text-red-600">
                                            {{ remaining_time }}
                                        </span>s
                                    </span>

                                    <span id="progress-percent"
                                        class="text-gray-500 font-medium">
                                        100%
                                    </span>
                                </div>

                                <div class="w-full bg-gray-200 h-5 rounded-full overflow-hidden">
                                    <div id="timer-progress"
                                        class="h-full bg-blue-600 text-white text-xs flex items-center justify-end pr-2 font-bold rounded-full"
                                        style="width: 100%;">
                                        100%
                                    </div>
                                </div>
                            </div>

                            <!-- QUIZ FORM -->
                            <form id="quiz-form"
                                hx-post="{% url 'learner:submit_assessment_new' assessment.id %}"
                                hx-target="#content-area"
                                hx-swap="innerHTML"
                                method="POST"
                                class="space-y-8">

                                {% csrf_token %}

                                {% for question in assessment.questions.all|shuffled %}
                                    <div class="p-6 bg-white rounded-2xl shadow-lg border border-gray-200">

                                        <h3 class="text-xl font-semibold text-gray-800 mb-5">
                                            {{ question.text|safe }}
                                        </h3>

                                        <div class="space-y-3">
                                            {% for choice in question.choices.all|shuffled %}
                                                {% with answer=answered_questions|get_question_answer:question.id %}

                                                    <label class="flex items-start gap-4 cursor-pointer p-4 border border-gray-300 rounded-xl hover:bg-gray-50 transition">

                                                        <input type="radio"
                                                            name="answers_{{ question.id }}"
                                                            value="{{ choice.id }}"
                                                            class="mt-1 h-5 w-5 text-indigo-600"
                                                            {% if answer and answer.choice.id == choice.id %}checked{% endif %}>

                                                        <span class="text-gray-700">{{ choice.text|safe }}</span>

                                                    </label>

                                                {% endwith %}
                                            {% endfor %}
                                        </div>

                                    </div>
                                {% endfor %}

                                <div class="text-center">
                                    <button type="submit"
                                            class="px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 shadow">
                                        Submit All Responses
                                    </button>
                                </div>
                            </form>

                            <!-- TIMER SCRIPT -->
                            <script>
                            (function () {
                                const timerEl = document.getElementById("timer-countdown");
                                const progress = document.getElementById("timer-progress");
                                const percentEl = document.getElementById("progress-percent");

                                if (!timerEl) return;

                                let total = parseInt(timerEl.textContent);
                                let left = total;

                                const iv = setInterval(() => {
                                    left--;
                                    const pct = Math.max(0, Math.round((left / total) * 100));

                                    timerEl.textContent = left;
                                    progress.style.width = pct + "%";
                                    progress.textContent = pct + "%";
                                    percentEl.textContent = pct + "%";

                                    if (pct <= 25) {
                                        progress.className = "h-full bg-red-600 text-white text-xs flex items-center justify-end pr-2 font-bold rounded-full";
                                    } else if (pct <= 50) {
                                        progress.className = "h-full bg-yellow-500 text-white text-xs flex items-center justify-end pr-2 font-bold rounded-full";
                                    } else {
                                        progress.className = "h-full bg-blue-600 text-white text-xs flex items-center justify-end pr-2 font-bold rounded-full";
                                    }

                                    if (left <= 0) {
                                        clearInterval(iv);
                                        htmx.trigger("#quiz-form", "submit");
                                    }

                                }, 1000);
                            })();
                            </script>

                        {% endif %}

                    {% else %}

                        <!-- START EXAM PROMPT -->
                        <div class="flex justify-center items-center min-h-screen bg-gray-50">
                            <div class="bg-white rounded-2xl shadow-xl p-10 max-w-lg text-center">

                                <div class="text-red-600 text-5xl mb-4">
                                    ðŸ“
                                </div>

                                <h2 class="text-2xl font-bold mb-3">Are You Ready to Begin the Test?</h2>

                                <p class="text-gray-500 mb-6">
                                    You will have <strong>{{ assessment.duration_in_minutes }} minutes</strong> to complete this assessment.
                                </p>

                                <form hx-post="{% url 'learner:start_assessment' assessment.id %}"
                                    hx-target="#content-area"
                                    hx-swap="innerHTML"
                                    hx-push-url="{% url 'learner:load_content' username=username id=course.id slug=slug content_type='assessment' content_id=assessment.id %}">
                                    <button class="px-6 py-3 border border-red-500 text-red-600 rounded-xl hover:bg-red-500 hover:text-white transition">
                                        Start Assessment
                                    </button>
                                </form>

                            </div>
                        </div>

                    {% endif %}
                {% endif %}


                {% if is_lti and lti_tool %}
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                        <h3 class="text-lg font-semibold text-gray-800 border-l-4 border-red-400 pl-3">
                            External Link Assessment
                        </h3>
                    </div>

                    <div class="text-center py-24 lg:py-32 bg-gradient-to-b from-indigo-50 to-white rounded-3xl shadow-lg">
                        <h4 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold mb-6 text-gray-800">
                            {{ lti_tool.tool_name }}
                        </h4>
                        <p class="text-lg lg:text-xl text-gray-600 mb-10 max-w-2xl mx-auto">
                            Access this external tool to enhance your learning experience. Click the button below to launch it in a new window and explore the resources prepared just for you.
                        </p>
                        <form action="{% url 'learner:lti_consume_course' assessment.id %}" method="get" target="_blank">
                            <button type="submit" class="inline-flex items-center justify-center px-8 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition duration-300">
                                Launch LTI Tool
                            </button>
                        </form>
                    </div>


                {% endif %}

                

            {% endif %}
        </div>
        {% endwith %}
    {% endif %}

    <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 mt-16 lg:mt-24">
        {% include 'learner/partials/navigation.html' %}
    </div>

{% else %}
    <div class="text-center py-32 lg:py-48">
        <p class="text-2xl lg:text-3xl text-gray-500">Please select a material or assessment from the sidebar.</p>
    </div>
{% endif %}

</main>

<!-- Welcome Modal (tetap sama, sudah responsif) -->
{% if messages %}
<div class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" id="welcomeModal">
    <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full overflow-hidden">
        <div class="p-8 text-center">
            <button onclick="document.getElementById('welcomeModal').remove()" class="float-right text-gray-500 hover:text-gray-700">
                <i class="bi bi-x-lg text-3xl"></i>
            </button>
            {% for message in messages %}
                <div class="prose prose-lg max-w-none text-gray-700">{{ message|safe }}</div>
            {% endfor %}
        </div>
        <div class="bg-gray-50 px-8 py-6 flex flex-col sm:flex-row gap-4">
            <button onclick="window.location.href='{% url 'courses:course_lms_detail' course.id course.slug %}'"
                    class="flex-1 py-4 border-2 border-gray-300 rounded-xl font-semibold hover:bg-gray-100 transition text-base lg:text-lg">
                View Course Details
            </button>
            <button onclick="document.getElementById('welcomeModal').remove()"
                    class="flex-1 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold hover:from-indigo-700 hover:to-purple-700 transition shadow-lg text-base lg:text-lg">
                Start Learning!
            </button>
        </div>
    </div>
</div>
{% endif %}

<script src="{% static 'js/pingSession.js' %}"></script>