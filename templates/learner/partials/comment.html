{% load learner_tags %}

<div id="comment-{{ comment.id }}"
     class="comment-wrapper mb-6 {% if level > 0 %}ml-{{ level|mul:10 }} pl-6 border-l-4 border-gray-200{% endif %}"
     x-data="{ replyOpen: false, repliesOpen: {{ comment.children.all|length|yesno:"true,false" }} }">

    <div class="flex gap-4">
        <!-- Avatar -->
        <div class="flex-shrink-0">
            {% if comment.user.photo %}
                <img src="{{ comment.user.photo.url }}" alt="{{ comment.user.username }}"
                     class="w-10 h-10 rounded-full object-cover">
            {% else %}
                <div class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-lg">
                    {{ comment.user.username|slice:":1"|upper }}
                </div>
            {% endif %}
        </div>

        <!-- Isi Komentar -->
        <div class="flex-1 min-w-0">
            <div class="flex justify-between items-start">
                <div>
                    <span class="font-semibold text-gray-900">{{ comment.user.username }}</span>
                    {% if comment.parent %}
                        <span class="text-sm text-gray-500 ml-2">
                            â†’ @{{ comment.parent.user.username }}
                        </span>
                    {% endif %}
                </div>
                <span class="text-sm text-gray-500 flex-shrink-0 ml-4">{{ comment.created_at|timesince }} ago</span>
            </div>

            <p class="mt-2 text-gray-800 break-words">{{ comment.content }}</p>

            <!-- Like, Dislike, Reply -->
            <div class="mt-3 flex items-center gap-5 text-sm">
                {% if user.is_authenticated %}
                    <!-- Like -->
                    <form hx-post="{% url 'learner:toggle_reaction' comment_id=comment.id reaction_type='like' %}?level={{ level }}"
                          hx-target="#comment-{{ comment.id }}"
                          hx-swap="outerHTML"
                          class="inline">
                        <button type="submit" class="flex items-center gap-1 hover:text-indigo-600 transition-colors {% if user_reactions|dict_get:comment.id == 'LIKE' %}text-indigo-600 font-bold{% else %}text-gray-600{% endif %}">
                            <svg class="w-5 h-5 {% if user_reactions|dict_get:comment.id == 'LIKE' %}fill-current{% else %}fill-none stroke-current{% endif %}" 
                                 viewBox="0 0 24 24" stroke-width="2">
                                <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            </svg>
                            <span>{{ comment.likes }}</span>
                        </button>
                    </form>

                    <!-- Dislike -->
                    <form hx-post="{% url 'learner:toggle_reaction' comment_id=comment.id reaction_type='dislike' %}?level={{ level }}"
                          hx-target="#comment-{{ comment.id }}"
                          hx-swap="outerHTML"
                          class="inline">
                        <button type="submit" class="flex items-center gap-1 hover:text-red-600 transition-colors {% if user_reactions|dict_get:comment.id == 'DISLIKE' %}text-red-600 font-bold{% else %}text-gray-600{% endif %}">
                            <svg class="w-5 h-5 {% if user_reactions|dict_get:comment.id == 'DISLIKE' %}fill-current{% else %}fill-none stroke-current{% endif %}" 
                                 viewBox="0 0 24 24" stroke-width="2">
                                <path d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.096c.5 0 .905-.405.905-.905 0-.715.211-1.413.608-2.008L17 13V4l-5-1-5 2z"/>
                            </svg>
                            <span>{{ comment.dislikes }}</span>
                        </button>
                    </form>

                    <!-- Reply Button -->
                    <button @click="replyOpen = !replyOpen" 
                            class="text-gray-600 hover:text-indigo-600 font-medium">
                        Reply
                    </button>
                {% else %}
                    <span class="text-gray-600">Like {{ comment.likes }}</span>
                    <span class="text-gray-600">Dislike {{ comment.dislikes }}</span>
                {% endif %}
            </div>

            <!-- Form Reply (Alpine Collapse) -->
            {% if user.is_authenticated %}
                <div x-show="replyOpen" 
                     x-transition 
                     class="mt-4 bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <form hx-post="{% url 'learner:add_comment' %}"
                          hx-target="#comments-section"
                          hx-swap="innerHTML"
                          hx-on::after-request="$dispatch('contentloaded'); this.reset(); replyOpen = false"
                          class="space-y-3">
                        <input type="hidden" name="material_id" value="{{ material.id|default:'' }}">
                        <input type="hidden" name="parent_id" value="{{ comment.id }}">
                        
                        <textarea name="comment_text" 
                                  rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
                                  placeholder="Tulis balasanmu..." required></textarea>

                        <div class="flex gap-3">
                            <button type="submit" 
                                    class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium text-sm transition">
                                Kirim Balasan
                            </button>
                            <button type="button" 
                                    @click="replyOpen = false"
                                    class="px-5 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-medium text-sm transition">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            {% endif %}

            <!-- Child Comments (Alpine Collapse) -->
            {% if comment.children.all %}
                <div class="mt-5">
                    <button @click="repliesOpen = !repliesOpen"
                            class="flex items-center gap-2 text-sm font-medium text-indigo-600 hover:text-indigo-800">
                        <svg :class="repliesOpen ? 'rotate-90' : ''" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        <span>{{ comment.children.count }} balasan</span>
                    </button>

                    <div x-show="repliesOpen" 
                         x-transition 
                         class="mt-4">
                        {% for child in comment.children.all %}
                            {% include 'learner/partials/comment.html' with comment=child user_reactions=user_reactions level=level|add:1 %}
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>