{% extends 'home/tes.html' %}
{% block content %}

<h3 class="text-xl font-semibold mb-4">
  Score Summary -
  <a href="{% url 'learner:course_learn' username=user.username id=course.id slug=course.slug %}"
     class="text-blue-600 hover:underline">
    {{ course.course_name }}
  </a>
</h3>

<!-- Table -->
<div class="overflow-x-auto mb-6">
  <table class="min-w-full border border-gray-300 text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="px-4 py-2 border">Assessment</th>
        <th class="px-4 py-2 border text-center">Max Score</th>
        <th class="px-4 py-2 border text-center">Score</th>
      </tr>
    </thead>
    <tbody>
      {% for result in assessment_results %}
      <tr class="border-t">
        <td class="px-4 py-2">{{ result.name }}</td>
        <td class="px-4 py-2 text-center">{{ result.max_score }}</td>
        <td class="px-4 py-2 text-center">{{ result.score|floatformat:2 }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">

  <!-- Overall Percentage -->
  <div class="border border-blue-500 rounded-xl p-4 shadow bg-white">
    <h5 class="font-medium text-gray-700 mb-1">Overall Percentage</h5>
    <p class="text-4xl font-bold">{{ overall_percentage }}%</p>
  </div>

  <!-- Status -->
  <div class="border border-blue-300 rounded-xl p-4 shadow bg-white">
    <h5 class="font-medium text-gray-700 mb-1">Status</h5>
    <p class="text-2xl font-semibold 
      {% if status == 'Pass' %} text-green-600 {% else %} text-red-600 {% endif %}">
      {{ status }}
    </p>
  </div>

  <!-- Grade -->
  <div class="border border-yellow-400 rounded-xl p-4 shadow bg-white">
    <h5 class="font-medium text-gray-700 mb-1">Grade</h5>
    <p class="text-2xl font-semibold">{{ grade }}</p>
  </div>

</div>

<!-- Progress Card -->
<div class="bg-white border rounded-xl p-6 shadow">

  <h5 class="text-lg font-semibold mb-4">Your Grade Progress</h5>

  <div class="flex flex-col gap-4">

    <!-- Progress Bar -->
    <div class="w-full h-6 bg-red-100 rounded overflow-hidden relative">
      {% if overall_percentage >= passing_threshold %}
        <div class="h-full bg-red-500"
             style="width: {{ passing_threshold }}%;"></div>
        <div class="h-full bg-green-500"
             style="width: calc({{ overall_percentage }}% - {{ passing_threshold }}%);"></div>
      {% else %}
        <div class="h-full bg-red-500"
             style="width: {{ overall_percentage }}%;"></div>
      {% endif %}
    </div>

    <!-- Threshold + User Markers -->
    <div class="flex justify-between text-center">

      <!-- Passing -->
      <div>
        <span class="inline-block bg-gray-900 text-white px-2 py-1 rounded text-sm">
          {{ passing_threshold }}%
        </span>
        <small class="block text-xs mt-1">Passing grade</small>
      </div>

      <!-- User score -->
      <div>
        <span class="inline-block px-2 py-1 rounded text-sm 
          {% if overall_percentage >= passing_threshold %}
            bg-green-600 text-white
          {% else %}
            bg-red-600 text-white
          {% endif %}
        ">
          {{ overall_percentage }}%
        </span>
        <small class="block text-xs mt-1">Your grade</small>
      </div>

    </div>

    <!-- Status Message -->
    <div class="mt-2 text-center p-3 rounded
      {% if status == 'Pass' %}
        bg-green-100 text-green-700
      {% else %}
        bg-red-100 text-red-700
      {% endif %}
    ">

      {% if status == 'Pass' %}

        ✔ You’re currently passing this course

      {% else %}

        <!-- Tooltip Tailwind Only -->
        <div class="relative group inline-block cursor-pointer underline decoration-dotted">

          You’re currently not passing this course

          <!-- Tooltip Panel -->
          <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-3
                      hidden group-hover:block
                      w-72 p-3 text-sm rounded-lg shadow-lg z-20
                      bg-gray-900 text-white">
            <strong>Graduation Threshold Criteria</strong><br><br>

            To pass this course, you must meet <strong>all</strong> of the following:

            <ul class="list-disc pl-4 mt-2 space-y-1">
              <li><strong>Overall Score:</strong> ≥ {{ passing_threshold }}% (your current: {{ overall_percentage }}%)</li>
              <li><strong>Course Progress:</strong> 100% (your current: {{ progress_percentage }}%)</li>
              <li><strong>All Assessments Submitted:</strong> {{ all_submitted|yesno:'Yes,No' }}</li>
              <li><strong>Grade Range:</strong> Within 'Pass' range</li>
            </ul>

            <br>
            <small>Tip: Complete remaining materials and assessments to improve!</small>
          </div>

        </div>

      {% endif %}
    </div>

  </div>
</div>

{% endblock %}
