{% extends 'home/tes.html' %}
{% load static %}

{% block content %}

<section class="bg-white border border-gray-200 p-6 rounded-lg shadow-sm hover:shadow-md transition">
      <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
        <h3 class="text-lg font-semibold text-gray-800 border-l-4 border-red-300 pl-2">User Analytics Dashboard</h3>
        
      </div>

   

    <!-- Filter & Download -->
    <form method="get" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        
        <!-- Gender Filter -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Gender</label>
            <select name="gender" 
                    class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition">
                <option value="">All Genders</option>
                <option value="male" {% if gender_filter == "male" %}selected{% endif %}>Male</option>
                <option value="female" {% if gender_filter == "female" %}selected{% endif %}>Female</option>
            </select>
        </div>

        <!-- Start Date -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
            <input type="date" name="start_date" 
                   value="{{ start_date }}"
                   class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition">
        </div>

        <!-- End Date -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
            <input type="date" name="end_date" 
                   value="{{ end_date }}"
                   class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition">
        </div>

        <!-- Buttons -->
        <div class="flex flex-col sm:flex-row gap-3">
            <button type="submit" 
                    class="flex-1 px-5 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition shadow-sm flex items-center justify-center gap-2">
                Filter
            </button>
            <a href="?{% if gender_filter %}gender={{ gender_filter }}&{% endif %}{% if start_date %}start_date={{ start_date }}&{% endif %}{% if end_date %}end_date={{ end_date }}&{% endif %}download=csv" 
               class="flex-1 px-5 py-2.5 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition shadow-sm flex items-center justify-center gap-2">
                Download CSV
            </a>
        </div>
    </form>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for chart in chart_list %}
        <div class="{% if chart.width == 12 %}md:col-span-2{% else %}md:col-span-1{% endif %}">
            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 hover:shadow-lg transition-shadow duration-300">
                <h5 class="text-lg font-semibold text-gray-800 mb-4">{{ chart.title }}</h5>
                <div class="relative h-64">
                    <canvas id="{{ chart.id }}"></canvas>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Empty State -->
    {% if not chart_list %}
    <div class="text-center py-12">
        <p class="text-gray-500 text-lg">No data available for the selected filters.</p>
    </div>
    {% endif %}
</div>
</section>
<!-- Chart.js -->
<script src="{% static 'js/chart.umd.min.js' %}"></script>

<!-- Chart Initialization -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const chartConfigs = {
        {% for chart in chart_list %}
        "{{ chart.id }}": {
            type: "{{ chart.type }}",
            data: {{ chart.data|safe }},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: "{{ chart.legend_position|default:'top' }}" },
                    title: { display: true, text: "{{ chart.title }}" }
                },
                {% if chart.index_axis %}indexAxis: "{{ chart.index_axis }}",{% endif %}
            }
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    for (const [id, config] of Object.entries(chartConfigs)) {
        const ctx = document.getElementById(id);
        if (ctx) {
            new Chart(ctx, config);
        }
    }
});
</script>

{% endblock %}