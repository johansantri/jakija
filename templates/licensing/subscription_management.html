{% extends 'home/tes.html' %}
{% load static %}
{% block content %}
<section class="bg-white border border-gray-200 p-6 rounded-lg shadow-sm hover:shadow-md transition">
<h2 class="text-2xl font-bold mb-4">Subscription Management</h2>

<!-- Tombol Tambah -->
<div class="mb-4">
    <a href="{% url 'licensing:license_create' %}" 
       class="bg-red-400 text-white px-4 py-2 rounded-lg hover:bg-red-500 transition text-sm">
        <i class="bi bi-plus-circle mr-2"></i> Add Subscription
    </a>
</div>

<!-- Statistik -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
    <div class="bg-white border border-gray-200 rounded-md shadow-sm mb-3 md:mb-0">
        <div class="px-4 py-3 border-b border-gray-200">
            <i class="bi bi-list-check mr-2"></i> Total Active Licenses
        </div>
        <div class="px-4 py-3">
            <h5 class="text-2xl font-bold text-gray-900">{{ total_licenses }}</h5>
        </div>
    </div>

<div class="bg-white border border-gray-200 rounded-md shadow-sm mb-3 md:mb-0">
    <div class="px-4 py-3 border-b border-gray-200">
        <i class="bi bi-file-earmark-x mr-2"></i> Total Expired Licenses
    </div>
    <div class="px-4 py-3">
        <h5 class="text-2xl font-bold text-gray-900">{{ total_expired_licenses }}</h5>
    </div>
</div>

<div class="bg-white border border-gray-200 rounded-md shadow-sm mb-3 md:mb-0">
    <div class="px-4 py-3 border-b border-gray-200">
        <i class="bi bi-calendar-x mr-2"></i> Licenses Approaching Expiry
    </div>
    <div class="px-4 py-3">
        <h5 class="text-2xl font-bold text-gray-900">{{ total_approaching_expiry }}</h5>
    </div>
</div></div>

<!-- Filter dan Search -->
<form method="get" class="mb-3 flex gap-2 flex-wrap">
    <input type="text" 
           name="q" 
           value="{{ request.GET.q }}" 
           class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
           placeholder="Search by name or university">
    <select name="status" class="px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <option value="">All Status</option>
        <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Active</option>
        <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Inactive</option>
    </select>
    <button type="submit" 
            class="px-4 py-2 text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 rounded-md transition-colors duration-150">Filter</button>
</form>

<!-- Tabel Semua Lisensi -->
<h3 class="text-xl font-semibold mb-2">All Active Licenses</h3>
{% if filtered_licenses %}
<div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 bg-white border border-gray-300 rounded-md">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">University</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">License Type</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiry Date</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max Users</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Users</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remaining Slots</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for license in filtered_licenses %}
                <tr class="hover:bg-gray-50 transition-colors duration-150">
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ license.name }} | {{ license.owner.email }}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ license.university.name }}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ license.license_type }}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ license.start_date }}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ license.expiry_date }}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ license.max_users }}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">
                        {{ license.users.count }}
                        <button type="button" 
                                class="ml-2 inline-flex items-center px-2.5 py-1 text-xs font-medium text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-md transition-colors duration-150" 
                                data-modal-target="usersModal{{ license.id }}">
                            View Users
                        </button>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ license.remaining_slots }}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        {% if license.status and license.expiry_date >= today %}
                            <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Active</span>
                        {% else %}
                            <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Inactive</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                        <a href="{% url 'licensing:license_update' license.pk %}" 
                           class="inline-flex items-center px-3 py-1 text-xs font-medium border border-blue-500 text-blue-500 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-md transition-colors duration-150">Edit</a>
                    </td>
                </tr>

            <!-- Modal untuk detail user (Tailwind-styled; gunakan JS/Alpine untuk toggle) -->
            <div id="usersModal{{ license.id }}" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
                <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <div class="flex justify-between items-center">
                            <h5 class="text-lg font-medium text-gray-900" id="usersModalLabel{{ license.id }}">
                                Users in License: {{ license.name }}
                            </h5>
                            <button type="button" class="text-gray-400 hover:text-gray-600" data-modal-hide="usersModal{{ license.id }}">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="mt-4 px-4 py-2">
                            {% if license.users.all %}
                                <ul class="divide-y divide-gray-200">
                                    {% for user in license.users.all %}
                                        <li class="py-2">
                                            <strong class="text-gray-900">{{ user.get_full_name }}</strong> ({{ user.email }})

                                            Username: {{ user.username }}

                                            {% if user.last_login %}
                                                <i class="text-gray-500">{{ user.last_login|date:"d-m-Y H:i" }}</i>
                                            {% else %}
                                                <span class="text-gray-500">Never logged in</span>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-gray-500">No users assigned to this license.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </tbody>
</table></div>
{% else %}
    <p class="text-gray-500">No licenses match the filter.</p>
{% endif %}
</section>
<!-- Catatan: Untuk modal functionality, gunakan Alpine.js atau custom JS untuk toggle class 'hidden'. Bootstrap JS telah dihilangkan. -->

{% endblock %}

